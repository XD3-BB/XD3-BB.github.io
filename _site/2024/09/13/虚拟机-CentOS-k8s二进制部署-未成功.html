<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1">--><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>虚拟机 Centos K8s二进制部署（未成功） | 小_屮、的博客日记</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="虚拟机 Centos K8s二进制部署（未成功）" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="服务器密码 mfhk12xx" />
<meta property="og:description" content="服务器密码 mfhk12xx" />
<link rel="canonical" href="http://localhost:4000/2024/09/13/%E8%99%9A%E6%8B%9F%E6%9C%BA-CentOS-k8s%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2-%E6%9C%AA%E6%88%90%E5%8A%9F.html" />
<meta property="og:url" content="http://localhost:4000/2024/09/13/%E8%99%9A%E6%8B%9F%E6%9C%BA-CentOS-k8s%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2-%E6%9C%AA%E6%88%90%E5%8A%9F.html" />
<meta property="og:site_name" content="小_屮、的博客日记" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-09-13T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="虚拟机 Centos K8s二进制部署（未成功）" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-09-13T00:00:00+08:00","datePublished":"2024-09-13T00:00:00+08:00","description":"服务器密码 mfhk12xx","headline":"虚拟机 Centos K8s二进制部署（未成功）","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2024/09/13/%E8%99%9A%E6%8B%9F%E6%9C%BA-CentOS-k8s%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2-%E6%9C%AA%E6%88%90%E5%8A%9F.html"},"url":"http://localhost:4000/2024/09/13/%E8%99%9A%E6%8B%9F%E6%9C%BA-CentOS-k8s%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2-%E6%9C%AA%E6%88%90%E5%8A%9F.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="小_屮、的博客日记" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">小_屮、的博客日记</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
            <a class="page-link" href="https://jekyllrb.com/" target="_blank">来自jekyll🤩</a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">虚拟机 Centos K8s二进制部署（未成功）</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-09-13T00:00:00+08:00" itemprop="datePublished">2024年09月13日
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">小_屮、</span></span></p><span class="tag-type">#运维</span><span class="tag-type">#linux</span><span class="tag-type">#CentOS</span><span class="tag-type">#虚拟机</span><span class="tag-type">#k8s</span><span class="tag-type">#kubernetes</span><span class="tag-type">#containerd</span></header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>服务器密码 mfhk12xx</p>

<p>服务启动失败，通过指令查看最近报错</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>journalctl -xe
</code></pre></div></div>

<p>也可通过指令查看最近服务的日志</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tail -f /var/log/messages
</code></pre></div></div>

<p>查看ETCD健康状态</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ETCD_PREFIX='ETCDCTL_API=3 etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints="https://192.168.100.100:2379,https://192.168.100.101:2379,https://192.168.100.102:2379" --write-out=table'
eval "${ETCD_PREFIX} endpoint health"
</code></pre></div></div>

<p>查看master组件健康状态</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl status kube-proxy
systemctl status kubelet
systemctl status kube-scheduler
systemctl status kube-controller-manager
systemctl status kube-apiserver
kubectl get cs
</code></pre></div></div>

<h1 id="前置操作">前置操作</h1>

<h2 id="搞奇数台linux服务器">搞奇数台linux服务器</h2>

<p>怎么搞的略，我搞了三个</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">host</th>
      <th style="text-align: center">ip</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">k8s-master</td>
      <td style="text-align: center">192.168.100.100</td>
    </tr>
    <tr>
      <td style="text-align: center">k8s-node1</td>
      <td style="text-align: center">192.168.100.101</td>
    </tr>
    <tr>
      <td style="text-align: center">k8s-node2</td>
      <td style="text-align: center">192.168.100.102</td>
    </tr>
  </tbody>
</table>

<h2 id="分配好主从节点">分配好主从节点</h2>

<p>每一台服务器都执行</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt;&gt; /etc/hosts &lt;&lt;EOF
192.168.100.100 k8s-master
192.168.100.101 k8s-node1
192.168.100.102 k8s-node2
EOF

</code></pre></div></div>

<h2 id="关闭防火墙">关闭防火墙</h2>

<p>这样的比较方便</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl stop firewalld
systemctl disable firewalld

</code></pre></div></div>

<h2 id="关闭swap">关闭swap</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sed -ri 's/.*swap.*/#&amp;/' /etc/fstab #永久
#swapoff -a   #临时

</code></pre></div></div>

<h2 id="关闭selinux">关闭selinux</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sed -i 's/enforcing/disabled/' /etc/selinux/config  #永久
#setenforce 0  # 临时 

</code></pre></div></div>

<h2 id="桥接流量转发">桥接流量转发</h2>

<p>每一台服务器都执行</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv6.conf.all.disable_ipv6=1
net.ipv4.ip_forward=1
EOF
sysctl --system

</code></pre></div></div>

<h2 id="时间同步">时间同步</h2>

<p>每一台服务器都执行</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install ntpdate -y
ntpdate time.windows.com

</code></pre></div></div>

<h2 id="主机名规划">主机名规划</h2>

<p>按照规划在对应ip的服务器执行对应的set-hostname</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hostnamectl set-hostname k8s-master 
hostnamectl set-hostname k8s-node1
hostnamectl set-hostname k8s-node2

</code></pre></div></div>

<h2 id="服务部署">服务部署</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ip</th>
      <th style="text-align: center">host</th>
      <th style="text-align: center">服务</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">192.168.100.100</td>
      <td style="text-align: center">k8s-master</td>
      <td style="text-align: center">kube-proxy<br />kubelet<br />kube-scheduler<br />kube-controller-manager<br />kube-apiserver</td>
    </tr>
    <tr>
      <td style="text-align: center">192.168.100.101</td>
      <td style="text-align: center">k8s-node1</td>
      <td style="text-align: center">kube-proxy<br />kubelet</td>
    </tr>
    <tr>
      <td style="text-align: center">192.168.100.102</td>
      <td style="text-align: center">k8s-node2</td>
      <td style="text-align: center">kube-proxy<br />kubelet</td>
    </tr>
  </tbody>
</table>

<h1 id="部署etcd">部署ETCD</h1>

<h2 id="下载cfssl">下载cfssl</h2>

<p>在某一台服务器上下载就行了</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://github.com/cloudflare/cfssl/releases/download/v1.6.3/cfssl_1.6.3_linux_amd64 -O /usr/local/bin/cfssl
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.3/cfssljson_1.6.3_linux_amd64 -O /usr/local/bin/cfssljson
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.3/cfssl-certinfo_1.6.3_linux_amd64 -O /usr/local/bin/cfssl-certinfo

chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson /usr/local/bin/cfssl-certinfo 

cp cfssl_1.6.3_linux_amd64 cfssl
cp cfssl-certinfo_1.6.3_linux_amd64 cfssl-certinfo
cp cfssljson_1.6.3_linux_amd64 cfssljson
</code></pre></div></div>

<p>wget下载不下来可以手动下载</p>

<h2 id="etcd证书创建">ETCD证书创建</h2>

<p>在下载了cfssl的服务器上执行</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /opt/etcd/{bin,cfg,ssl} -p
cd /opt/etcd/ssl/
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi ca-config.json
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "signing": {
        "default": {
            "expiry": "87600h"
        },
        "profiles": {
            "etcd": {
                "expiry": "87600h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "server auth",
                    "client auth"
                ]
            }
        }
    }
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi ca-csr.json
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "CN": "etcd CA",
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "Beijing",
            "L": "Beijing"
        }
    ]
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi server-csr.json
</code></pre></div></div>

<p>下面的hosts需要改成自己的</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "CN": "etcd",
    "hosts": [
         "192.168.100.100",
         "192.168.100.101",
         "192.168.100.102"
        ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "Beijing",
            "L": "Beijing"
        }
    ]
}
</code></pre></div></div>

<p>生成</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert -initca ca-csr.json | cfssljson -bare ca
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd server-csr.json | cfssljson -bare server
</code></pre></div></div>

<p>证书拷贝到所有节点的相同位置，主要是ca.pem、server.pem、server-key.pem三个文件，我放在/opt/etcd/ssl/内部</p>

<h2 id="etcd集群搭建">ETCD集群搭建</h2>

<p>在一台服务器下载etcd</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ETCD_VER=v3.4.24

//这两个都可以
GOOGLE_URL=https://storage.googleapis.com/etcd
GITHUB_URL=https://github.com/etcd-io/etcd/releases/download
DOWNLOAD_URL=${GOOGLE_URL}

rm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
rm -rf /tmp/etcd-download-test &amp;&amp; mkdir -p /tmp/etcd-download-test

curl -L ${DOWNLOAD_URL}/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz -o /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
tar xzvf /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz -C /tmp/etcd-download-test --strip-components=1
rm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /tmp/etcd-download-test/
cp etcd etcdctl /usr/local/bin/
</code></pre></div></div>

<p>这里的etcd、etcdctl两个文件拷贝到全部节点的/usr/local/bin/目录内</p>

<p>对所有节点进行下面的操作，配置文件注意改一部分</p>

<hr />

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /opt/etcd/cfg/etcd.conf
</code></pre></div></div>

<p>配置文件</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ETCD_INITIAL_CLUSTER_STATEETCD_INITIAL_CLUSTER_STATE#[Member]
ETCD_DATA_DIR="/var/lib/etcd/default.etcd"
ETCD_NAME="etcd01"#修改为ETCD_INITIAL_CLUSTER中=右边为本机ip的左边的name
ETCD_LISTEN_PEER_URLS="https://192.168.100.100:2380" #修改为本机ip
ETCD_LISTEN_CLIENT_URLS="https://192.168.100.100:2379,http://127.0.0.1:2379"#修改为本机ip
#[Clustering]
ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.100.100:2380"#修改为本机ip
ETCD_ADVERTISE_CLIENT_URLS="https://192.168.100.100:2379"#修改为本机ip

#下面的名字跟ip需要事先规划下
ETCD_INITIAL_CLUSTER="etcd01=https://192.168.100.100:2380,etcd02=https://192.168.100.101:2380,etcd03=https://192.168.100.102:2380"
ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"
ETCD_INITIAL_CLUSTER_STATE="new"
#[Security]

#这里是前面cfssl创建的证书，用于开启TLS
ETCD_CERT_FILE="/opt/etcd/ssl/server.pem"
ETCD_KEY_FILE="/opt/etcd/ssl/server-key.pem"
ETCD_TRUSTED_CA_FILE="/opt/etcd/ssl/ca.pem"
ETCD_CLIENT_CERT_AUTH="true"
ETCD_PEER_CERT_FILE="/opt/etcd/ssl/server.pem"
ETCD_PEER_KEY_FILE="/opt/etcd/ssl/server-key.pem"
ETCD_PEER_TRUSTED_CA_FILE="/opt/etcd/ssl/ca.pem"
ETCD_PEER_CLIENT_CERT_AUTH="true"
</code></pre></div></div>

<p>字段介绍，下面的代码块是介绍，看看就行</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--initial-cluster：集群当中的其他节点
--cert-file：etcd证书路径
--key-file：etcd私钥路径
--peer-cert-file：对等证书(双向证书)路径
--peer-key-file：对等证书(双向证书)私钥路径
--trusted-ca-file：作为客户端时的CA证书路径
--peer-trusted-ca-file：对等证书的CA证书路径
--initial-advertise-peer-urls：列出集群成员通信的URL，用于通告集群其他成员
--listen-peer-urls：用于监听集群其他成员的URL列表
--listen-client-urls：用于监听客户端通讯的URL列表
--advertise-client-urls：通告客户端的URL，用于列出所有客户端
--initial-cluster-token：etcd集群的初始集群令牌，服务器必须通过令牌才能加入etcd集群
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /usr/lib/systemd/system/etcd.service
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
EnvironmentFile=-/opt/etcd/cfg/etcd.conf
ExecStart=/usr/local/bin/etcd
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
</code></pre></div></div>

<p>然后启动服务，组成集群的几个节点需要同时开启etcd服务，从上到下的指令分别是：</p>

<p>读取服务文件、开机启动etcd、开启etcd服务、查看etcd运行状态</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl enable etcd
systemctl start etcd
systemctl status etcd

</code></pre></div></div>

<p>运行状态是running就行</p>

<p>这里的服务启动要同时，ETCD_INITIAL_CLUSTER配置有几台就要在几台启动。</p>

<p>服务启动要是报错了有提示、可以百度看看哪里有问题</p>

<hr />

<p>到这里就部署完毕了，后面是对部署结果的查看</p>

<p>使用脚手架的固定前缀，证书位置自己定，服务器ip自己改</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ETCD_PREFIX='ETCDCTL_API=3 etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints="https://192.168.100.100:2379,https://192.168.100.101:2379,https://192.168.100.102:2379" --write-out=table'
</code></pre></div></div>

<p>查看成员信息</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>eval "${ETCD_PREFIX} member list"
</code></pre></div></div>

<p>查看集群状态</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>eval "${ETCD_PREFIX} endpoint health"
</code></pre></div></div>

<p>全部的health列都是true表示部署完成，这个时候如果有某一个health是false，重启那一个etcd。</p>

<p>重启前修改配置的ETCD_INITIAL_CLUSTER_STATE为”existing”，然后执行下面的指令即可</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart etcd
</code></pre></div></div>

<h1 id="部署containerd">部署Containerd</h1>

<p>全部节点按照下面的步骤进行container部署</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /opt/{containerd,cni/bin} -p
</code></pre></div></div>

<p>下container的载gz安装包跟cni的gz安装包还有runc的二进制包，这里container使用1.7.0版本，cni使用1.2.0，runc使用1.1.4</p>

<p>containerd下载</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/containerd/containerd/releases/download/v1.7.0/containerd-1.7.0-linux-amd64.tar.gz
</code></pre></div></div>

<p>cni插件</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/containernetworking/plugins/releases/download/v1.2.0/cni-plugins-linux-amd64-v1.2.0.tgz
</code></pre></div></div>

<p>runc插件</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64
</code></pre></div></div>

<p>containerd文件放到/opt/containerd解压，ctr放到系统环境</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp /opt/containerd/bin/ctr  /usr/local/bin
</code></pre></div></div>

<p>cni放到/opt/cni/bin解压</p>

<p>解压命令</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tar -zxf *gz
</code></pre></div></div>

<p>在放置runc.amd64的地方运行</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>install -m 755 runc.amd64 /usr/local/sbin/runc
</code></pre></div></div>

<p>先启动一次</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /etc/systemd/system/containerd.service &lt;&lt;EOF
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target
 
[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/opt/containerd/bin/containerd
Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=infinity
TasksMax=infinity
OOMScoreAdjust=-999
 
[Install]
WantedBy=multi-user.target
EOF
systemctl daemon-reload
systemctl enable containerd
systemctl start containerd
systemctl status containerd
</code></pre></div></div>

<p>配置Containerd所需的模块</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /etc/modules-load.d/containerd.conf &lt;&lt;EOF
overlay
br_netfilter
EOF
systemctl restart systemd-modules-load.service
</code></pre></div></div>

<p>配置Containerd所需的内核</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt;&gt; /etc/sysctl.d/99-kubernetes-cri.conf &lt;&lt; EOF
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
sysctl --system
</code></pre></div></div>

<p>创建cni配置文件</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /etc/cni/net.d/ -p
cat &gt; /etc/cni/net.d/10-mynet.conf &lt;&lt;EOF
{
    "cniVersion": "1.0.0",
    "name": "mynet",
    "type": "bridge",
    "bridge": "cni0",
    "isGateway": true,
    "ipMasq": true,
    "ipam": {
        "type": "host-local",
        "subnet": "10.88.0.0/16",
        "routes": [
            {
                "dst": "0.0.0.0/0"
            }
        ]
    }
}
EOF
cat &gt; /etc/cni/net.d/99-loopback.conf &lt;&lt;EOF
{
    "cniVerion": "1.0.0",
    "name": "lo",
    "type": "loopback"
}
EOF
</code></pre></div></div>

<p>创建Containerd的配置文件</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /etc/containerd
/opt/containerd/bin/containerd config default | tee /etc/containerd/config.toml
</code></pre></div></div>

<p><strong>修改Containerd的配置文件/etc/containerd/config.toml，几个配置是分开的</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#这个配置里的[plugins."io.containerd.grpc.v1.cri"]
sandbox_image = "registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6"
#这个配置里的[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options] SystemdCgroup注释掉
# SystemdCgroup = true
</code></pre></div></div>

<p>查看配置里的这一项config_path，没有自己加</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[plugins."io.containerd.grpc.v1.cri".registry]
  config_path = "/etc/containerd/certs.d"
</code></pre></div></div>

<p>查看命名空间</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ctr namespaces ls
</code></pre></div></div>

<p>创建命名空间的配置</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /etc/containerd/certs.d/k8s.io -p
</code></pre></div></div>

<p>配置镜像加速host.后面的改成自己阿里云的免费镜像加速地址</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt;  /etc/containerd/certs.d/k8s.io/hosts.toml  &lt;&lt;EOF
server = "https://k8s.io"

[host."https://d68wvxw0.mirror.aliyuncs.com"]
  capabilities = ["pull", "resolve", "push"]
EOF
</code></pre></div></div>

<p>启动测试</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart containerd
ctr version

</code></pre></div></div>

<p>##</p>

<h1 id="主节点部署master组件">主节点部署Master组件</h1>

<h2 id="下载源码">下载源码</h2>

<p>这里有全部版本的日志，进去这个页面下滑有很多版本</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG
</code></pre></div></div>

<p>点击版本进去后就能看到版本的下载链接</p>

<p>点击Download for xxx，进去找到Server Binaries，是Server，下载第一个kubernetes-server-linux-amd64.tar.gz</p>

<p>我下载的1.26.3版本，之后到规划的Master服务器跑代码</p>

<p>规划一个放k8s的文件夹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir -p /opt/kubernetes/{bin,cfg,ssl,logs} 
</code></pre></div></div>

<p>将下载的gz文件放在/opt/kubernetes/目录下</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /opt/kubernetes
tar zxvf kubernetes-server-linux-amd64.tar.gz
cd kubernetes/server/bin
cp kube-apiserver kube-scheduler kube-controller-manager kubelet kube-proxy kubectl kubeadm /opt/kubernetes/bin
cp kubectl kubeadm /usr/bin/
</code></pre></div></div>

<h2 id="部署kube-apiserver">部署kube-apiserver</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /opt/kubernetes/ssl/kube-apiserver

cd /opt/kubernetes/ssl/kube-apiserver


cat &gt; ca-config.json &lt;&lt; EOF
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "kubernetes": {
         "expiry": "87600h",
         "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ]
      }
    }
  }
}
EOF
cat &gt; ca-csr.json &lt;&lt; EOF
{
    "CN": "kubernetes",
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "Beijing",
            "ST": "Beijing",
            "O": "k8s",
            "OU": "System"
        }
    ]
}
EOF

cat &gt; server-csr.json &lt;&lt; EOF
{
    "CN": "kubernetes",
    "hosts": [
      "127.0.0.1",
      "192.168.100.100",
      "192.168.100.101",
      "192.168.100.102",
      "k8s-master",
      "k8s-node1",
      "k8s-node2"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "L": "BeiJing",
            "ST": "BeiJing",
            "O": "k8s",
            "OU": "System"
        }
    ]
}
EOF

</code></pre></div></div>

<p>生成证书</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server

</code></pre></div></div>

<p>创建配置</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; EOF
KUBE_APISERVER_OPTS="--v=2 \\
--etcd-servers=https://192.168.100.100:2379,https://192.168.100.101:2379,https://192.168.100.102:2379 \\
--etcd-cafile=/opt/etcd/ssl/ca.pem \\
--etcd-certfile=/opt/etcd/ssl/server.pem \\
--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\
--bind-address=192.168.100.100 \\
--secure-port=6443 \\
--advertise-address=192.168.100.100 \\
--allow-privileged=true \\
--authorization-mode=RBAC,Node \\
--token-auth-file=/opt/kubernetes/cfg/token.csv \\
--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\
--enable-bootstrap-token-auth=true \\
--service-cluster-ip-range=10.0.0.0/24 \\
--service-node-port-range=30000-32767 \\
--service-account-issuer=api \\
--service-account-key-file=/opt/kubernetes/ssl/kube-apiserver/ca-key.pem \\
--service-account-signing-key-file=/opt/kubernetes/ssl/kube-apiserver/server-key.pem \\
--proxy-client-cert-file=/opt/kubernetes/ssl/kube-apiserver/server.pem \\
--proxy-client-key-file=/opt/kubernetes/ssl/kube-apiserver/server-key.pem \\
--kubelet-client-certificate=/opt/kubernetes/ssl/kube-apiserver/server.pem \\
--kubelet-client-key=/opt/kubernetes/ssl/kube-apiserver/server-key.pem \\
--tls-cert-file=/opt/kubernetes/ssl/kube-apiserver/server.pem  \\
--tls-private-key-file=/opt/kubernetes/ssl/kube-apiserver/server-key.pem \\
--client-ca-file=/opt/kubernetes/ssl/kube-apiserver/ca.pem \\
--requestheader-client-ca-file=/opt/kubernetes/ssl/kube-apiserver/ca.pem \\
--requestheader-allowed-names=kubernetes \\
--requestheader-extra-headers-prefix=X-Remote-Extra- \\
--requestheader-group-headers=X-Remote-Group \\
--requestheader-username-headers=X-Remote-User \\
--enable-aggregator-routing=true \\
--audit-log-maxage=30 \\
--audit-log-maxbackup=3 \\
--audit-log-maxsize=100 \\
--audit-log-path=/opt/kubernetes/logs/k8s-audit.log"
EOF

</code></pre></div></div>

<p>生成一个token</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>head -c 16 /dev/urandom | od -An -t x | tr -d ' '

</code></pre></div></div>

<p>写入bootstraping验证token的文件</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; EOF
dcbfd5e168fde8abda5ed8b0fda3291f,kubelet-bootstrap,10001,"system:node-bootstrapper"
EOF

</code></pre></div></div>

<p>创建apiserver服务</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf
ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl enable kube-apiserver
systemctl start kube-apiserver 
systemctl status kube-apiserver 

</code></pre></div></div>

<p>状态是running就ok</p>

<h2 id="部署kube-controller-manager">部署kube-controller-manager</h2>

<p>创建配置</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; EOF
KUBE_CONTROLLER_MANAGER_OPTS="--v=2 \\
--leader-elect=true \\
--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\
--bind-address=127.0.0.1 \\
--allocate-node-cidrs=true \\
--cluster-cidr=10.244.0.0/16 \\
--service-cluster-ip-range=10.0.0.0/24 \\
--cluster-signing-cert-file=/opt/kubernetes/ssl/kube-apiserver/ca.pem \\
--cluster-signing-key-file=/opt/kubernetes/ssl/kube-apiserver/ca-key.pem  \\
--root-ca-file=/opt/kubernetes/ssl/kube-apiserver/ca.pem \\
--service-account-private-key-file=/opt/kubernetes/ssl/kube-apiserver/ca-key.pem \\
--cluster-signing-duration=87600h0m0s"
EOF

</code></pre></div></div>

<p>生成证书</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /opt/kubernetes/ssl/kube-controller-manager
cd /opt/kubernetes/ssl/kube-controller-manager
cp /opt/kubernetes/ssl/kube-apiserver/ca* /opt/kubernetes/ssl/kube-controller-manager
cat &gt; kube-controller-manager-csr.json &lt;&lt; EOF
{
  "CN": "system:kube-controller-manager",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "BeiJing", 
      "ST": "BeiJing",
      "O": "system:masters",
      "OU": "System"
    }
  ]
}
EOF
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager

</code></pre></div></div>

<p>shell执行以下命令生成kubeconfig文件</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KUBE_CONFIG="/opt/kubernetes/cfg/kube-controller-manager.kubeconfig"
KUBE_APISERVER="https://192.168.100.100:6443"

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/kube-apiserver/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-credentials kube-controller-manager \
  --client-certificate=/opt/kubernetes/ssl/kube-controller-manager/kube-controller-manager.pem \
  --client-key=/opt/kubernetes/ssl/kube-controller-manager/kube-controller-manager-key.pem \
  --embed-certs=true \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-controller-manager \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}

</code></pre></div></div>

<p>创建服务</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf
ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

</code></pre></div></div>

<p>启动</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl enable kube-controller-manager
systemctl start kube-controller-manager
systemctl status kube-controller-manager

</code></pre></div></div>

<p>状态是running就ok</p>

<h2 id="部署-kube-scheduler">部署 kube-scheduler</h2>

<p>创建配置</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; EOF
KUBE_SCHEDULER_OPTS="--v=2 \\
--leader-elect \\
--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\
--bind-address=127.0.0.1"
EOF

</code></pre></div></div>

<p>生成证书</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /opt/kubernetes/ssl/kube-scheduler
cd /opt/kubernetes/ssl/kube-scheduler
cp /opt/kubernetes/ssl/kube-apiserver/ca* /opt/kubernetes/ssl/kube-scheduler
# 创建证书请求文件
cat &gt; kube-scheduler-csr.json &lt;&lt; EOF
{
  "CN": "system:kube-scheduler",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "BeiJing",
      "ST": "BeiJing",
      "O": "system:masters",
      "OU": "System"
    }
  ]
}
EOF
# 生成证书
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler

</code></pre></div></div>

<p>生成</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KUBE_CONFIG="/opt/kubernetes/cfg/kube-scheduler.kubeconfig"
KUBE_APISERVER="https://192.168.100.100:6443"

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/kube-apiserver/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-credentials kube-scheduler \
  --client-certificate=/opt/kubernetes/ssl/kube-scheduler/kube-scheduler.pem \
  --client-key=/opt/kubernetes/ssl/kube-scheduler/kube-scheduler-key.pem \
  --embed-certs=true \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-scheduler \
  --kubeconfig=${KUBE_CONFIG}
    
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}

</code></pre></div></div>

<p>创建服务管理</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf
ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

</code></pre></div></div>

<p>启动</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl enable kube-scheduler
systemctl start kube-scheduler
systemctl status kube-scheduler

</code></pre></div></div>

<h2 id="集群管理前配置">集群管理前配置</h2>

<p>生成集群链接证书</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /opt/kubernetes/ssl/kube-link
cd /opt/kubernetes/ssl/kube-link
cp /opt/kubernetes/ssl/kube-apiserver/ca* /opt/kubernetes/ssl/kube-link

cat &gt; admin-csr.json &lt;&lt;EOF
{
  "CN": "admin",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "BeiJing",
      "ST": "BeiJing",
      "O": "system:masters",
      "OU": "System"
    }
  ]
}
EOF

cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin

</code></pre></div></div>

<p>创建kubeconfig文件</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /root/.kube

KUBE_CONFIG="/root/.kube/config"
KUBE_APISERVER="https://192.168.100.100:6443"

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/kube-link/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-credentials cluster-admin \
  --client-certificate=/opt/kubernetes/ssl/kube-link/admin.pem \
  --client-key=/opt/kubernetes/ssl/kube-link/admin-key.pem \
  --embed-certs=true \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-context default \
  --cluster=kubernetes \
  --user=cluster-admin \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}

</code></pre></div></div>

<p>查看节点组件状态</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> kubectl get cs
</code></pre></div></div>

<p>health全是true就是组件正常</p>

<p>创建用户</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create clusterrolebinding kubelet-bootstrap \
--clusterrole=system:node-bootstrapper \
--user=kubelet-bootstrap

</code></pre></div></div>

<h1 id="集群全部节点部署">集群全部节点部署</h1>

<h2 id="安装ctictl">安装ctictl</h2>

<p>下载</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.26.1/crictl-v1.26.1-linux-amd64.tar.gz
</code></pre></div></div>

<p>解压后移动到环境变量里</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tar -zxvf crictl-v1.26.1-linux-amd64.tar.gz
mv crictl /usr/local/bin/
</code></pre></div></div>

<p>添加crictl配置</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /etc/crictl.yaml &lt;&lt;EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 2
debug: false
pull-image-on-create: false
disable-pull-on-run: false
EOF

</code></pre></div></div>

<h2 id="master部署kubelet">（master）部署kubelet</h2>

<p>先在master节点按照下面的步骤kubelet部署</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /opt/kubernetes/cfg/kubelet-config.yml &lt;&lt; EOF
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
cgroupDriver: cgroupfs
clusterDNS:
- 10.0.0.2
clusterDomain: k8s-master 
failSwapOn: false
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /opt/kubernetes/ssl/kube-apiserver/ca.pem 
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
maxOpenFiles: 1000000
maxPods: 110
EOF

</code></pre></div></div>

<p>创建bootstrap.kubeconfig</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KUBE_CONFIG="/opt/kubernetes/cfg/bootstrap.kubeconfig"
KUBE_APISERVER="https://192.168.100.100:6443" 
TOKEN="dcbfd5e168fde8abda5ed8b0fda3291f"

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/kube-apiserver/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-credentials "kubelet-bootstrap" \
  --token=${TOKEN} \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-context default \
  --cluster=kubernetes \
  --user="kubelet-bootstrap" \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; EOF
KUBELET_OPTS="--hostname-override=k8s-master \\
--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\
--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\
--config=/opt/kubernetes/cfg/kubelet-config.yml \\
--cert-dir=/opt/kubernetes/ssl/kube-link \\
--container-runtime-endpoint=unix:///run/containerd/containerd.sock"
EOF

</code></pre></div></div>

<p>创建服务</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Kubelet
After=docker.service

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf
ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl enable kubelet
systemctl start kubelet
systemctl status kubelet

</code></pre></div></div>

<p>允许kubelet证书申请并加入集群</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get csr
#上面的命令执行后的表格，取name那一块作为下面命令的参数
kubectl certificate approve node-csr-t8Gq2LXx4SJ-WDa-HFeuc0ESNvEZ8oMTsZcaybs1NII
#执行下面的命令能看到k8s-master展示列表状态为ready
kubectl get nodes

</code></pre></div></div>

<h2 id="master部署kube-proxy">（master）部署kube-proxy</h2>

<p>创建配置</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; EOF
KUBE_PROXY_OPTS="--v=2 \\
--config=/opt/kubernetes/cfg/kube-proxy-config.yml"
EOF
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; EOF
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
metricsBindAddress: 0.0.0.0:10249
clientConnection:
  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig
hostnameOverride: k8s-master
clusterCIDR: 10.244.0.0/16
EOF
</code></pre></div></div>

<p>创建证书</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /opt/kubernetes/ssl/kube-proxy
cd /opt/kubernetes/ssl/kube-proxy
cp /opt/kubernetes/ssl/kube-apiserver/ca* /opt/kubernetes/ssl/kube-proxy
cat &gt; kube-proxy-csr.json &lt;&lt; EOF
{
  "CN": "system:kube-proxy",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "BeiJing",
      "ST": "BeiJing",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
EOF
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy

</code></pre></div></div>

<p>生成kube-proxy.kubeconfig文件</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>KUBE_CONFIG="/opt/kubernetes/cfg/kube-proxy.kubeconfig"
KUBE_APISERVER="https://192.168.100.100:6443"
CERT_PATH="/opt/kubernetes/ssl/kube-proxy"

kubectl config set-cluster kubernetes \
  --certificate-authority=${CERT_PATH}/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-credentials kube-proxy \
  --client-certificate=${CERT_PATH}/kube-proxy.pem \
  --client-key=${CERT_PATH}/kube-proxy-key.pem \
  --embed-certs=true \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-proxy \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}

</code></pre></div></div>

<p>创建服务</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Proxy
After=network.target

[Service]
    EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf
ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl enable kube-proxy
systemctl start kube-proxy
systemctl status kube-proxy

</code></pre></div></div>

<h2 id="master添加网络管理组件">（master）添加网络管理组件</h2>

<p>下载calicotl</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://github.com/projectcalico/calico/releases/download/v3.25.0/calicoctl-linux-amd64
</code></pre></div></div>

<p>放到/usr/local/bin/中</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mv /usr/local/bin/calicoctl-linux-amd64 /usr/local/bin/calicoctl
chmod +x /usr/local/bin/calicoctl
</code></pre></div></div>

<p>下载配置</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml
</code></pre></div></div>

<p>放到/opt/kubernetes/cfg/中</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply -f /opt/kubernetes/cfg/calico.yaml
kubectl get pods -n kube-system
</code></pre></div></div>

<h2 id="node复制节点">（node）复制节点</h2>

<p>master节点</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /opt/kubernetes
tar zvcf kube.gz bin/ cfg/ ssl/

</code></pre></div></div>

<p>将/opt/kubernetes/下的kube.gz文件下载下来</p>

<p>子节点</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /opt/kubernetes

</code></pre></div></div>

<p>将刚刚下载的kube.gz文件上传到/opt/kubernetes/</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> tar -zxvf kube.gz
 
</code></pre></div></div>

<p>删除部分配置，每个节点不同</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm -f /opt/kubernetes/cfg/kubelet.kubeconfig 
rm -f /opt/kubernetes/ssl/kube-link/kubelet*

</code></pre></div></div>

<p>修改主机名称</p>

<hr />

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /opt/kubernetes/cfg/kubelet.conf

</code></pre></div></div>

<p>修改：–hostname-override=k8s-node1</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /opt/kubernetes/cfg/kube-proxy-config.yml

</code></pre></div></div>

<p>修改：hostnameOverride: k8s-node1</p>

<hr />

<p>创建软连接（创建服务）kubelet与kube-proxy</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Kubelet
After=docker.service

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf
ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Proxy
After=network.target

[Service]
    EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf
ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

</code></pre></div></div>

<p>这里可以开一个新的ssh专门打日志</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> tail -f /var/log/messages
</code></pre></div></div>

<p>开启kubelet</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl enable kubelet
systemctl start kubelet
systemctl status kubelet

</code></pre></div></div>

<p>开启kube-proxy</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl enable kube-proxy
systemctl start kube-proxy
systemctl status kube-proxy

</code></pre></div></div>

<p>在Master上同意新的Node kubelet证书申请</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get csr
kubectl certificate approve #后面是上面语句获取的NAME列的一行
</code></pre></div></div>

<p>查看节点</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nodes
</code></pre></div></div>

<p>有三个Ready的</p>

  </div>

  <a class="u-url" href="/2024/09/13/%E8%99%9A%E6%8B%9F%E6%9C%BA-CentOS-k8s%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2-%E6%9C%AA%E6%88%90%E5%8A%9F.html" hidden></a>

  <div class="previous-next"><div class="previous-post">
        👈🏻:<a href="/2023/09/06/Linux-CentOS-%E5%A6%82%E4%BD%95%E6%B3%A8%E5%86%8C%E8%87%AA%E5%B7%B1%E7%9A%84%E6%9C%8D%E5%8A%A1.html">Linux Centos 如何注册自己的服务</a>
      </div><div class="next-post">
        <a href="/jekyll/update/2024/09/24/welcome-to-jekyll.html">Welcome to Jekyll!</a>:👉🏻
      </div></div>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <ul class="contact-list">
          <li class="p-name">Google邮箱,一般不看</li>
          <li><a class="u-email" href="mailto:xunderlinec1960@gmail.com">xunderlinec1960@gmail.com</a></li>
        </ul>
      </div>
      
      <div class="footer-col">
        <ul class="contact-list">
          <li class="p-name">QQ邮箱，有事发这里</li>
          <li><a class="u-email" href="mailto:1960481101@qq.com">1960481101@qq.com</a></li>
        </ul>
      </div>
      
      <div class="footer-col">
        <ul class="contact-list">
          <li class="p-name">github基本没在用</li>
          <li><a href="https://github.com/XD3-BB"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">XD3-BB</span></a></li>
        </ul>
      </div>
    </div>

      <div class="footer-col footer-col-3">
        <span class="p-name">WordPress收费，Ghost又太大了，2核2G的服务器跑不起来。。还得是jekyll🥰</span>
      </div>
  </div>

</footer>
</body>

</html>
