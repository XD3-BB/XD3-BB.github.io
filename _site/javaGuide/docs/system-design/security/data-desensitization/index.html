<!-- @include: @article-header.snippet.md -->

<blockquote>
  <p>本文转载完善自<a href="https://mp.weixin.qq.com/s/1qFWczesU50ndPPLtABHFg">Hutool：一行代码搞定数据脱敏 - 京东云开发者</a>。</p>
</blockquote>

<h2 id="什么是数据脱敏">什么是数据脱敏</h2>

<h3 id="数据脱敏的定义">数据脱敏的定义</h3>

<p>数据脱敏百度百科中是这样定义的：</p>

<blockquote>
  <p>数据脱敏，指对某些敏感信息通过脱敏规则进行数据的变形，实现敏感隐私数据的可靠保护。这样就可以在开发、测试和其它非生产环境以及外包环境中安全地使用脱敏后的真实数据集。在涉及客户安全数据或者一些商业性敏感数据的情况下，在不违反系统规则条件下，对真实数据进行改造并提供测试使用，如身份证号、手机号、卡号、客户号等个人信息都需要进行数据脱敏。是数据库安全技术之一。</p>
</blockquote>

<p>总的来说，数据脱敏是指对某些敏感信息通过脱敏规则进行数据的变形，实现敏感隐私数据的可靠保护。</p>

<p>在数据脱敏过程中，通常会采用不同的算法和技术，以根据不同的需求和场景对数据进行处理。例如，对于身份证号码，可以使用掩码算法（masking）将前几位数字保留，其他位用 “X” 或 “*” 代替；对于姓名，可以使用伪造（pseudonymization）算法，将真实姓名替换成随机生成的假名。</p>

<h3 id="常用脱敏规则">常用脱敏规则</h3>

<p>常用脱敏规则是为了保护敏感数据的安全性，在处理和存储敏感数据时对其进行变换或修改。</p>

<p>下面是几种常见的脱敏规则：</p>

<ul>
  <li>替换(常用)：将敏感数据中的特定字符或字符序列替换为其他字符。例如，将信用卡号中的中间几位数字替换为星号（*）或其他字符。</li>
  <li>删除：将敏感数据中的部分内容随机删除。比如，将电话号码的随机 3 位数字进行删除。</li>
  <li>重排：将原始数据中的某些字符或字段的顺序打乱。例如，将身份证号码的随机位交错互换。</li>
  <li>加噪：在数据中注入一些误差或者噪音，达到对数据脱敏的效果。例如，在敏感数据中添加一些随机生成的字符。</li>
  <li>加密（常用）：使用加密算法将敏感数据转换为密文。例如，将银行卡号用 MD5 或 SHA-256 等哈希函数进行散列。常见加密算法总结可以参考这篇文章：<a href="https://javaguide.cn/system-design/security/encryption-algorithms.html">https://javaguide.cn/system-design/security/encryption-algorithms.html</a> 。</li>
  <li>……</li>
</ul>

<h2 id="常用脱敏工具">常用脱敏工具</h2>

<h3 id="hutool">Hutool</h3>

<p>Hutool 一个 Java 基础工具类，对文件、流、加密解密、转码、正则、线程、XML 等 JDK 方法进行封装，组成各种 Util 工具类，同时提供以下组件：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">模块</th>
      <th style="text-align: center">介绍</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">hutool-aop</td>
      <td style="text-align: center">JDK 动态代理封装，提供非 IOC 下的切面支持</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-bloomFilter</td>
      <td style="text-align: center">布隆过滤，提供一些 Hash 算法的布隆过滤</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-cache</td>
      <td style="text-align: center">简单缓存实现</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-core</td>
      <td style="text-align: center">核心，包括 Bean 操作、日期、各种 Util 等</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-cron</td>
      <td style="text-align: center">定时任务模块，提供类 Crontab 表达式的定时任务</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-crypto</td>
      <td style="text-align: center">加密解密模块，提供对称、非对称和摘要算法封装</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-db</td>
      <td style="text-align: center">JDBC 封装后的数据操作，基于 ActiveRecord 思想</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-dfa</td>
      <td style="text-align: center">基于 DFA 模型的多关键字查找</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-extra</td>
      <td style="text-align: center">扩展模块，对第三方封装（模板引擎、邮件、Servlet、二维码、Emoji、FTP、分词等）</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-http</td>
      <td style="text-align: center">基于 HttpUrlConnection 的 Http 客户端封装</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-log</td>
      <td style="text-align: center">自动识别日志实现的日志门面</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-script</td>
      <td style="text-align: center">脚本执行封装，例如 Javascript</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-setting</td>
      <td style="text-align: center">功能更强大的 Setting 配置文件和 Properties 封装</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-system</td>
      <td style="text-align: center">系统参数调用封装（JVM 信息等）</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-json</td>
      <td style="text-align: center">JSON 实现</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-captcha</td>
      <td style="text-align: center">图片验证码实现</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-poi</td>
      <td style="text-align: center">针对 POI 中 Excel 和 Word 的封装</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-socket</td>
      <td style="text-align: center">基于 Java 的 NIO 和 AIO 的 Socket 封装</td>
    </tr>
    <tr>
      <td style="text-align: center">hutool-jwt</td>
      <td style="text-align: center">JSON Web Token (JWT) 封装实现</td>
    </tr>
  </tbody>
</table>

<p>可以根据需求对每个模块单独引入，也可以通过引入<code class="language-plaintext highlighter-rouge">hutool-all</code>方式引入所有模块，本文所使用的数据脱敏工具就是在 <code class="language-plaintext highlighter-rouge">hutool.core</code> 模块。</p>

<p>现阶段最新版本的 Hutool 支持的脱敏数据类型如下，基本覆盖了常见的敏感信息。</p>

<ol>
  <li>用户 id</li>
  <li>中文姓名</li>
  <li>身份证号</li>
  <li>座机号</li>
  <li>手机号</li>
  <li>地址</li>
  <li>电子邮件</li>
  <li>密码</li>
  <li>中国大陆车牌，包含普通车辆、新能源车辆</li>
  <li>银行卡</li>
</ol>

<h4 id="一行代码实现脱敏">一行代码实现脱敏</h4>

<p>Hutool 提供的脱敏方法如下图所示：</p>

<p><img src="https://oss.javaguide.cn/github/javaguide/system-design/security/2023-08-01-10-2119fnVCIDozqHgRGx.png" alt="" /></p>

<p>注意：Hutool 脱敏是通过 * 来代替敏感信息的，具体实现是在 StrUtil.hide 方法中，如果我们想要自定义隐藏符号，则可以把 Hutool 的源码拷出来，重新实现即可。</p>

<p>这里以手机号、银行卡号、身份证号、密码信息的脱敏为例，下面是对应的测试代码。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cn.hutool.core.util.DesensitizedUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.Spring</span> <span class="nc">BootTest</span><span class="o">;</span>

<span class="cm">/**
 *
 * @description: Hutool实现数据脱敏
 */</span>
<span class="nd">@Spring</span> <span class="nc">BootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HuToolDesensitizationTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPhoneDesensitization</span><span class="o">(){</span>
        <span class="nc">String</span> <span class="n">phone</span><span class="o">=</span><span class="s">"13723231234"</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">mobilePhone</span><span class="o">(</span><span class="n">phone</span><span class="o">));</span> <span class="c1">//输出：137****1234</span>
    <span class="o">}</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBankCardDesensitization</span><span class="o">(){</span>
        <span class="nc">String</span> <span class="n">bankCard</span><span class="o">=</span><span class="s">"6217000130008255666"</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">bankCard</span><span class="o">(</span><span class="n">bankCard</span><span class="o">));</span> <span class="c1">//输出：6217 **** **** *** 5666</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIdCardNumDesensitization</span><span class="o">(){</span>
        <span class="nc">String</span> <span class="n">idCardNum</span><span class="o">=</span><span class="s">"411021199901102321"</span><span class="o">;</span>
        <span class="c1">//只显示前4位和后2位</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">idCardNum</span><span class="o">(</span><span class="n">idCardNum</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">2</span><span class="o">));</span> <span class="c1">//输出：4110************21</span>
    <span class="o">}</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPasswordDesensitization</span><span class="o">(){</span>
        <span class="nc">String</span> <span class="n">password</span><span class="o">=</span><span class="s">"www.jd.com_35711"</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="n">password</span><span class="o">));</span> <span class="c1">//输出：****************</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>以上就是使用 Hutool 封装好的工具类实现数据脱敏。</p>

<h4 id="配合-jackson-通过注解方式实现脱敏">配合 JackSon 通过注解方式实现脱敏</h4>

<p>现在有了数据脱敏工具类，如果前端需要显示数据数据的地方比较多，我们不可能在每个地方都调用一个工具类，这样就显得代码太冗余了，那我们如何通过注解的方式优雅的完成数据脱敏呢？</p>

<p>如果项目是基于 Spring Boot 的 web 项目，则可以利用 Spring Boot 自带的 jackson 自定义序列化实现。它的实现原理其实就是在 json 进行序列化渲染给前端时，进行脱敏。</p>

<p><strong>第一步：脱敏策略的枚举。</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @author
 * @description:脱敏策略枚举
 */</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">DesensitizationTypeEnum</span> <span class="o">{</span>
    <span class="c1">//自定义</span>
    <span class="no">MY_RULE</span><span class="o">,</span>
    <span class="c1">//用户id</span>
    <span class="no">USER_ID</span><span class="o">,</span>
    <span class="c1">//中文名</span>
    <span class="no">CHINESE_NAME</span><span class="o">,</span>
    <span class="c1">//身份证号</span>
    <span class="no">ID_CARD</span><span class="o">,</span>
    <span class="c1">//座机号</span>
    <span class="no">FIXED_PHONE</span><span class="o">,</span>
    <span class="c1">//手机号</span>
    <span class="no">MOBILE_PHONE</span><span class="o">,</span>
    <span class="c1">//地址</span>
    <span class="no">ADDRESS</span><span class="o">,</span>
    <span class="c1">//电子邮件</span>
    <span class="no">EMAIL</span><span class="o">,</span>
    <span class="c1">//密码</span>
    <span class="no">PASSWORD</span><span class="o">,</span>
    <span class="c1">//中国大陆车牌，包含普通车辆、新能源车辆</span>
    <span class="no">CAR_LICENSE</span><span class="o">,</span>
    <span class="c1">//银行卡</span>
    <span class="no">BANK_CARD</span>
<span class="o">}</span>
</code></pre></div></div>

<p>上面表示支持的脱敏类型。</p>

<p><strong>第二步：定义一个用于脱敏的 Desensitization 注解。</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">@Retention (RetentionPolicy.RUNTIME)</code>：运行时生效。</li>
  <li><code class="language-plaintext highlighter-rouge">@Target (ElementType.FIELD)</code>：可用在字段上。</li>
  <li><code class="language-plaintext highlighter-rouge">@JacksonAnnotationsInside</code>：此注解可以点进去看一下是一个元注解，主要是用户打包其他注解一起使用。</li>
  <li><code class="language-plaintext highlighter-rouge">@JsonSerialize</code>：上面说到过，该注解的作用就是可自定义序列化，可以用在注解上，方法上，字段上，类上，运行时生效等等，根据提供的序列化类里面的重写方法实现自定义序列化。</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @author
 */</span>
<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@JacksonAnnotationsInside</span>
<span class="nd">@JsonSerialize</span><span class="o">(</span><span class="n">using</span> <span class="o">=</span> <span class="nc">DesensitizationSerialize</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Desensitization</span> <span class="o">{</span>
    <span class="cm">/**
     * 脱敏数据类型，在MY_RULE的时候，startInclude和endExclude生效
     */</span>
    <span class="nc">DesensitizationTypeEnum</span> <span class="nf">type</span><span class="o">()</span> <span class="k">default</span> <span class="nc">DesensitizationTypeEnum</span><span class="o">.</span><span class="na">MY_RULE</span><span class="o">;</span>

    <span class="cm">/**
     * 脱敏开始位置（包含）
     */</span>
    <span class="kt">int</span> <span class="nf">startInclude</span><span class="o">()</span> <span class="k">default</span> <span class="mi">0</span><span class="o">;</span>

    <span class="cm">/**
     * 脱敏结束位置（不包含）
     */</span>
    <span class="kt">int</span> <span class="nf">endExclude</span><span class="o">()</span> <span class="k">default</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>注：只有使用了自定义的脱敏枚举 <code class="language-plaintext highlighter-rouge">MY_RULE</code> 的时候，开始位置和结束位置才生效。</p>

<p><strong>第三步：创建自定的序列化类</strong></p>

<p>这一步是我们实现数据脱敏的关键。自定义序列化类继承 <code class="language-plaintext highlighter-rouge">JsonSerializer</code>，实现 <code class="language-plaintext highlighter-rouge">ContextualSerializer</code> 接口，并重写两个方法。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @author
 * @description: 自定义序列化类
 */</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DesensitizationSerialize</span> <span class="kd">extends</span> <span class="nc">JsonSerializer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">ContextualSerializer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">DesensitizationTypeEnum</span> <span class="n">type</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">startInclude</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">endExclude</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">serialize</span><span class="o">(</span><span class="nc">String</span> <span class="n">str</span><span class="o">,</span> <span class="nc">JsonGenerator</span> <span class="n">jsonGenerator</span><span class="o">,</span> <span class="nc">SerializerProvider</span> <span class="n">serializerProvider</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 自定义类型脱敏</span>
            <span class="k">case</span> <span class="nl">MY_RULE:</span>
                <span class="n">jsonGenerator</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="nc">CharSequenceUtil</span><span class="o">.</span><span class="na">hide</span><span class="o">(</span><span class="n">str</span><span class="o">,</span> <span class="n">startInclude</span><span class="o">,</span> <span class="n">endExclude</span><span class="o">));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="c1">// userId脱敏</span>
            <span class="k">case</span> <span class="nl">USER_ID:</span>
                <span class="n">jsonGenerator</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">userId</span><span class="o">()));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="c1">// 中文姓名脱敏</span>
            <span class="k">case</span> <span class="nl">CHINESE_NAME:</span>
                <span class="n">jsonGenerator</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">chineseName</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">)));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="c1">// 身份证脱敏</span>
            <span class="k">case</span> <span class="nl">ID_CARD:</span>
                <span class="n">jsonGenerator</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">idCardNum</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">),</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="c1">// 固定电话脱敏</span>
            <span class="k">case</span> <span class="nl">FIXED_PHONE:</span>
                <span class="n">jsonGenerator</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">fixedPhone</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">)));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="c1">// 手机号脱敏</span>
            <span class="k">case</span> <span class="nl">MOBILE_PHONE:</span>
                <span class="n">jsonGenerator</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">mobilePhone</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">)));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="c1">// 地址脱敏</span>
            <span class="k">case</span> <span class="nl">ADDRESS:</span>
                <span class="n">jsonGenerator</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">address</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">),</span> <span class="mi">8</span><span class="o">));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="c1">// 邮箱脱敏</span>
            <span class="k">case</span> <span class="nl">EMAIL:</span>
                <span class="n">jsonGenerator</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">email</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">)));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="c1">// 密码脱敏</span>
            <span class="k">case</span> <span class="nl">PASSWORD:</span>
                <span class="n">jsonGenerator</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">)));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="c1">// 中国车牌脱敏</span>
            <span class="k">case</span> <span class="nl">CAR_LICENSE:</span>
                <span class="n">jsonGenerator</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">carLicense</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">)));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="c1">// 银行卡脱敏</span>
            <span class="k">case</span> <span class="nl">BANK_CARD:</span>
                <span class="n">jsonGenerator</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="nc">DesensitizedUtil</span><span class="o">.</span><span class="na">bankCard</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">)));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">default</span><span class="o">:</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">JsonSerializer</span><span class="o">&lt;?&gt;</span> <span class="n">createContextual</span><span class="o">(</span><span class="nc">SerializerProvider</span> <span class="n">serializerProvider</span><span class="o">,</span> <span class="nc">BeanProperty</span> <span class="n">beanProperty</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JsonMappingException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">beanProperty</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 判断数据类型是否为String类型</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">beanProperty</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">getRawClass</span><span class="o">(),</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// 获取定义的注解</span>
                <span class="nc">Desensitization</span> <span class="n">desensitization</span> <span class="o">=</span> <span class="n">beanProperty</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">Desensitization</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="c1">// 为null</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">desensitization</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">desensitization</span> <span class="o">=</span> <span class="n">beanProperty</span><span class="o">.</span><span class="na">getContextAnnotation</span><span class="o">(</span><span class="nc">Desensitization</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="c1">// 不为null</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">desensitization</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 创建定义的序列化类的实例并且返回，入参为注解定义的type,开始位置，结束位置。</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">DesensitizationSerialize</span><span class="o">(</span><span class="n">desensitization</span><span class="o">.</span><span class="na">type</span><span class="o">(),</span> <span class="n">desensitization</span><span class="o">.</span><span class="na">startInclude</span><span class="o">(),</span>
                            <span class="n">desensitization</span><span class="o">.</span><span class="na">endExclude</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="n">serializerProvider</span><span class="o">.</span><span class="na">findValueSerializer</span><span class="o">(</span><span class="n">beanProperty</span><span class="o">.</span><span class="na">getType</span><span class="o">(),</span> <span class="n">beanProperty</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">serializerProvider</span><span class="o">.</span><span class="na">findNullValueSerializer</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>经过上述三步，已经完成了通过注解实现数据脱敏了，下面我们来测试一下。</p>

<p>首先定义一个要测试的 pojo，对应的字段加入要脱敏的策略。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 *
 * @description:
 */</span>
<span class="nd">@Data</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestPojo</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userName</span><span class="o">;</span>

    <span class="nd">@Desensitization</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">DesensitizationTypeEnum</span><span class="o">.</span><span class="na">MOBILE_PHONE</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">phone</span><span class="o">;</span>

    <span class="nd">@Desensitization</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">DesensitizationTypeEnum</span><span class="o">.</span><span class="na">PASSWORD</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="nd">@Desensitization</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="nc">DesensitizationTypeEnum</span><span class="o">.</span><span class="na">MY_RULE</span><span class="o">,</span> <span class="n">startInclude</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">endExclude</span> <span class="o">=</span> <span class="mi">2</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">address</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>接下来写一个测试的 controller</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/test"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">TestPojo</span> <span class="nf">testDesensitization</span><span class="o">(){</span>
        <span class="nc">TestPojo</span> <span class="n">testPojo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TestPojo</span><span class="o">();</span>
        <span class="n">testPojo</span><span class="o">.</span><span class="na">setUserName</span><span class="o">(</span><span class="s">"我是用户名"</span><span class="o">);</span>
        <span class="n">testPojo</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="s">"地球中国-北京市通州区京东总部2号楼"</span><span class="o">);</span>
        <span class="n">testPojo</span><span class="o">.</span><span class="na">setPhone</span><span class="o">(</span><span class="s">"13782946666"</span><span class="o">);</span>
        <span class="n">testPojo</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"sunyangwei123123123."</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">testPojo</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">testPojo</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p><img src="https://oss.javaguide.cn/github/javaguide/system-design/security/2023-08-02-16-497DdCBy8vbf2D69g.png" alt="" /></p>

<p>可以看到我们成功实现了数据脱敏。</p>

<h3 id="apache-shardingsphere">Apache ShardingSphere</h3>

<p>ShardingSphere 是一套开源的分布式数据库中间件解决方案组成的生态圈，它由 Sharding-JDBC、Sharding-Proxy 和 Sharding-Sidecar（计划中）这 3 款相互独立的产品组成。 他们均提供标准化的数据分片、分布式事务和数据库治理功能 。</p>

<p>Apache ShardingSphere 下面存在一个数据脱敏模块，此模块集成的常用的数据脱敏的功能。其基本原理是对用户输入的 SQL 进行解析拦截，并依靠用户的脱敏配置进行 SQL 的改写，从而实现对原文字段的加密及加密字段的解密。最终实现对用户无感的加解密存储、查询。</p>

<p>通过 Apache ShardingSphere 可以自动化&amp;透明化数据脱敏过程，用户无需关注脱敏中间实现细节。并且，提供了多种内置、第三方(AKS)的脱敏策略，用户仅需简单配置即可使用。</p>

<p>官方文档地址：<a href="https://shardingsphere.apache.org/document/4.1.1/cn/features/orchestration/encrypt/">https://shardingsphere.apache.org/document/4.1.1/cn/features/orchestration/encrypt/</a> 。</p>

<h3 id="fastjson">FastJSON</h3>

<p>平时开发 Web 项目的时候，除了默认的 Spring 自带的序列化工具，FastJson 也是一个很常用的 Spring Web Restful 接口序列化的工具。</p>

<p>FastJSON 实现数据脱敏的方式主要有两种：</p>

<ul>
  <li>基于注解 <code class="language-plaintext highlighter-rouge">@JSONField</code> 实现：需要自定义一个用于脱敏的序列化的类，然后在需要脱敏的字段上通过 <code class="language-plaintext highlighter-rouge">@JSONField</code> 中的 <code class="language-plaintext highlighter-rouge">serializeUsing</code> 指定为我们自定义的序列化类型即可。</li>
  <li>基于序列化过滤器：需要实现 <code class="language-plaintext highlighter-rouge">ValueFilter</code> 接口，重写 <code class="language-plaintext highlighter-rouge">process</code> 方法完成自定义脱敏，然后在 JSON 转换时使用自定义的转换策略。具体实现可参考这篇文章： <a href="https://juejin.cn/post/7067916686141161479">https://juejin.cn/post/7067916686141161479</a>。</li>
</ul>

<h3 id="mybatis-mate">Mybatis-Mate</h3>

<p>先介绍一下 MyBatis、MyBatis-Plus 和 Mybatis-Mate 这三者的关系：</p>

<ul>
  <li>MyBatis 是一款优秀的持久层框架，它支持定制化 SQL、存储过程以及高级映射。</li>
  <li>MyBatis-Plus 是一个 MyBatis 的增强工具，能够极大地简化持久层的开发工作。</li>
  <li>Mybatis-Mate 是为 MyBatis-Plus 提供的企业级模块，旨在更敏捷优雅处理数据。不过，使用之前需要配置授权码（付费）。</li>
</ul>

<p>Mybatis-Mate 支持敏感词脱敏，内置手机号、邮箱、银行卡号等 9 种常用脱敏规则。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@FieldSensitive</span><span class="o">(</span><span class="s">"testStrategy"</span><span class="o">)</span>
<span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SensitiveStrategyConfig</span> <span class="o">{</span>

    <span class="cm">/**
     * 注入脱敏策略
     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ISensitiveStrategy</span> <span class="nf">sensitiveStrategy</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 自定义 testStrategy 类型脱敏处理</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">SensitiveStrategy</span><span class="o">().</span><span class="na">addStrategy</span><span class="o">(</span><span class="s">"testStrategy"</span><span class="o">,</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">+</span> <span class="s">"***test***"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 跳过脱密处理，用于编辑场景</span>
<span class="nc">RequestDataTransfer</span><span class="o">.</span><span class="na">skipSensitive</span><span class="o">();</span>
</code></pre></div></div>

<h3 id="mybatis-flex">MyBatis-Flex</h3>

<p>类似于 MybatisPlus，MyBatis-Flex 也是一个 MyBatis 增强框架。MyBatis-Flex 同样提供了数据脱敏功能，并且是可以免费使用的。</p>

<p>MyBatis-Flex 提供了 <code class="language-plaintext highlighter-rouge">@ColumnMask()</code> 注解，以及内置的 9 种脱敏规则，开箱即用：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 内置的数据脱敏方式
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Masks</span> <span class="o">{</span>
    <span class="cm">/**
     * 手机号脱敏
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MOBILE</span> <span class="o">=</span> <span class="s">"mobile"</span><span class="o">;</span>
    <span class="cm">/**
     * 固定电话脱敏
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">FIXED_PHONE</span> <span class="o">=</span> <span class="s">"fixed_phone"</span><span class="o">;</span>
    <span class="cm">/**
     * 身份证号脱敏
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ID_CARD_NUMBER</span> <span class="o">=</span> <span class="s">"id_card_number"</span><span class="o">;</span>
    <span class="cm">/**
     * 中文名脱敏
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CHINESE_NAME</span> <span class="o">=</span> <span class="s">"chinese_name"</span><span class="o">;</span>
    <span class="cm">/**
     * 地址脱敏
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ADDRESS</span> <span class="o">=</span> <span class="s">"address"</span><span class="o">;</span>
    <span class="cm">/**
     * 邮件脱敏
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">EMAIL</span> <span class="o">=</span> <span class="s">"email"</span><span class="o">;</span>
    <span class="cm">/**
     * 密码脱敏
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PASSWORD</span> <span class="o">=</span> <span class="s">"password"</span><span class="o">;</span>
    <span class="cm">/**
     * 车牌号脱敏
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CAR_LICENSE</span> <span class="o">=</span> <span class="s">"car_license"</span><span class="o">;</span>
    <span class="cm">/**
     * 银行卡号脱敏
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">BANK_CARD_NUMBER</span> <span class="o">=</span> <span class="s">"bank_card_number"</span><span class="o">;</span>
    <span class="c1">//...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>使用示例：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Table</span><span class="o">(</span><span class="s">"tb_account"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>

    <span class="nd">@Id</span><span class="o">(</span><span class="n">keyType</span> <span class="o">=</span> <span class="nc">KeyType</span><span class="o">.</span><span class="na">Auto</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ColumnMask</span><span class="o">(</span><span class="nc">Masks</span><span class="o">.</span><span class="na">CHINESE_NAME</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userName</span><span class="o">;</span>

    <span class="nd">@ColumnMask</span><span class="o">(</span><span class="nc">Masks</span><span class="o">.</span><span class="na">EMAIL</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></div></div>

<p>如果这些内置的脱敏规则不满足你的要求的话，你还可以自定义脱敏规则。</p>

<p>1、通过 <code class="language-plaintext highlighter-rouge">MaskManager</code> 注册新的脱敏规则：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MaskManager</span><span class="o">.</span><span class="na">registerMaskProcessor</span><span class="o">(</span><span class="s">"自定义规则名称"</span>
        <span class="o">,</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
        <span class="o">})</span>
</code></pre></div></div>

<p>2、使用自定义的脱敏规则</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Table</span><span class="o">(</span><span class="s">"tb_account"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>

    <span class="nd">@Id</span><span class="o">(</span><span class="n">keyType</span> <span class="o">=</span> <span class="nc">KeyType</span><span class="o">.</span><span class="na">Auto</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ColumnMask</span><span class="o">(</span><span class="s">"自定义规则名称"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userName</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>并且，对于需要跳过脱密处理的场景，例如进入编辑页面编辑用户数据，MyBatis-Flex 也提供了对应的支持：</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">MaskManager#execWithoutMask</code></strong>（推荐）：该方法使用了模版方法设计模式，保障跳过脱敏处理并执行相关逻辑后自动恢复脱敏处理。</li>
  <li><strong><code class="language-plaintext highlighter-rouge">MaskManager#skipMask</code></strong>：跳过脱敏处理。</li>
  <li><strong><code class="language-plaintext highlighter-rouge">MaskManager#restoreMask</code></strong>：恢复脱敏处理，确保后续的操作继续使用脱敏逻辑。</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">MaskManager#execWithoutMask</code>方法实现如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">execWithoutMask</span><span class="o">(</span><span class="nc">Supplier</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">supplier</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">skipMask</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">supplier</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">restoreMask</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">MaskManager</code> 的<code class="language-plaintext highlighter-rouge">skipMask</code>和<code class="language-plaintext highlighter-rouge">restoreMask</code>方法一般配套使用，推荐<code class="language-plaintext highlighter-rouge">try{...}finally{...}</code>模式。</p>

<h2 id="总结">总结</h2>

<p>这篇文章主要介绍了：</p>

<ul>
  <li>数据脱敏的定义：数据脱敏是指对某些敏感信息通过脱敏规则进行数据的变形，实现敏感隐私数据的可靠保护。</li>
  <li>常用的脱敏规则：替换、删除、重排、加噪和加密。</li>
  <li>常用的脱敏工具：Hutool、Apache ShardingSphere、FastJSON、Mybatis-Mate 和 MyBatis-Flex。</li>
</ul>

<h2 id="参考">参考</h2>

<ul>
  <li>Hutool 工具官网： <a href="https://hutool.cn/docs/#/">https://hutool.cn/docs/#/</a></li>
  <li>聊聊如何自定义数据脱敏：<a href="https://juejin.cn/post/7046567603971719204">https://juejin.cn/post/7046567603971719204</a></li>
  <li>FastJSON 实现数据脱敏：<a href="https://juejin.cn/post/7067916686141161479">https://juejin.cn/post/7067916686141161479</a></li>
</ul>

<!-- @include: @article-footer.snippet.md -->
