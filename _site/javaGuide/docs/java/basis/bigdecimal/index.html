<p>《阿里巴巴 Java 开发手册》中提到：“为了避免精度丢失，可以使用 <code class="language-plaintext highlighter-rouge">BigDecimal</code> 来进行浮点数的运算”。</p>

<p>浮点数的运算竟然还会有精度丢失的风险吗？确实会！</p>

<p>示例代码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0f</span> <span class="o">-</span> <span class="mf">1.9f</span><span class="o">;</span>
<span class="kt">float</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">1.8f</span> <span class="o">-</span> <span class="mf">1.7f</span><span class="o">;</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">);</span><span class="c1">// 0.100000024</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">b</span><span class="o">);</span><span class="c1">// 0.099999905</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="o">);</span><span class="c1">// false</span>
</code></pre></div></div>

<p><strong>为什么浮点数 <code class="language-plaintext highlighter-rouge">float</code> 或 <code class="language-plaintext highlighter-rouge">double</code> 运算的时候会有精度丢失的风险呢？</strong></p>

<p>这个和计算机保存浮点数的机制有很大关系。我们知道计算机是二进制的，而且计算机在表示一个数字时，宽度是有限的，无限循环的小数存储在计算机时，只能被截断，所以就会导致小数精度发生损失的情况。这也就是解释了为什么浮点数没有办法用二进制精确表示。</p>

<p>就比如说十进制下的 0.2 就没办法精确转换成二进制小数：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 0.2 转换为二进制数的过程为，不断乘以 2，直到不存在小数为止，</span>
<span class="c1">// 在这个计算过程中，得到的整数部分从上到下排列就是二进制的结果。</span>
<span class="mf">0.2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">-&gt;</span> <span class="mi">0</span>
<span class="mf">0.4</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">-&gt;</span> <span class="mi">0</span>
<span class="mf">0.8</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">=</span> <span class="mf">1.6</span> <span class="o">-&gt;</span> <span class="mi">1</span>
<span class="mf">0.6</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="o">-&gt;</span> <span class="mi">1</span>
<span class="mf">0.2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">-&gt;</span> <span class="mi">0</span><span class="err">（</span><span class="n">发生循环</span><span class="err">）</span>
<span class="o">...</span>
</code></pre></div></div>

<p>关于浮点数的更多内容，建议看一下<a href="http://kaito-kidd.com/2018/08/08/computer-system-float-point/">计算机系统基础（四）浮点数</a>这篇文章。</p>

<h2 id="bigdecimal-介绍">BigDecimal 介绍</h2>

<p><code class="language-plaintext highlighter-rouge">BigDecimal</code> 可以实现对浮点数的运算，不会造成精度丢失。</p>

<p>通常情况下，大部分需要浮点数精确运算结果的业务场景（比如涉及到钱的场景）都是通过 <code class="language-plaintext highlighter-rouge">BigDecimal</code> 来做的。</p>

<p>《阿里巴巴 Java 开发手册》中提到：<strong>浮点数之间的等值判断，基本数据类型不能用 == 来比较，包装数据类型不能用 equals 来判断。</strong></p>

<p><img src="https://oss.javaguide.cn/javaguide/image-20211213101646884.png" alt="" /></p>

<p>具体原因我们在上面已经详细介绍了，这里就不多提了。</p>

<p>想要解决浮点数运算精度丢失这个问题，可以直接使用 <code class="language-plaintext highlighter-rouge">BigDecimal</code> 来定义浮点数的值，然后再进行浮点数的运算操作即可。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BigDecimal</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"1.0"</span><span class="o">);</span>
<span class="nc">BigDecimal</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"0.9"</span><span class="o">);</span>
<span class="nc">BigDecimal</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"0.8"</span><span class="o">);</span>

<span class="nc">BigDecimal</span> <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">subtract</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
<span class="nc">BigDecimal</span> <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">subtract</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>

<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">y</span><span class="o">));</span><span class="c1">// 0</span>
</code></pre></div></div>

<h2 id="bigdecimal-常见方法">BigDecimal 常见方法</h2>

<h3 id="创建">创建</h3>

<p>我们在使用 <code class="language-plaintext highlighter-rouge">BigDecimal</code> 时，为了防止精度丢失，推荐使用它的<code class="language-plaintext highlighter-rouge">BigDecimal(String val)</code>构造方法或者 <code class="language-plaintext highlighter-rouge">BigDecimal.valueOf(double val)</code> 静态方法来创建对象。</p>

<p>《阿里巴巴 Java 开发手册》对这部分内容也有提到，如下图所示。</p>

<p><img src="https://oss.javaguide.cn/javaguide/image-20211213102222601.png" alt="" /></p>

<h3 id="加减乘除">加减乘除</h3>

<p><code class="language-plaintext highlighter-rouge">add</code> 方法用于将两个 <code class="language-plaintext highlighter-rouge">BigDecimal</code> 对象相加，<code class="language-plaintext highlighter-rouge">subtract</code> 方法用于将两个 <code class="language-plaintext highlighter-rouge">BigDecimal</code> 对象相减。<code class="language-plaintext highlighter-rouge">multiply</code> 方法用于将两个 <code class="language-plaintext highlighter-rouge">BigDecimal</code> 对象相乘，<code class="language-plaintext highlighter-rouge">divide</code> 方法用于将两个 <code class="language-plaintext highlighter-rouge">BigDecimal</code> 对象相除。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BigDecimal</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"1.0"</span><span class="o">);</span>
<span class="nc">BigDecimal</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"0.9"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">b</span><span class="o">));</span><span class="c1">// 1.9</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">subtract</span><span class="o">(</span><span class="n">b</span><span class="o">));</span><span class="c1">// 0.1</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">multiply</span><span class="o">(</span><span class="n">b</span><span class="o">));</span><span class="c1">// 0.90</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">divide</span><span class="o">(</span><span class="n">b</span><span class="o">));</span><span class="c1">// 无法除尽，抛出 ArithmeticException 异常</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">divide</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="nc">RoundingMode</span><span class="o">.</span><span class="na">HALF_UP</span><span class="o">));</span><span class="c1">// 1.11</span>
</code></pre></div></div>

<p>这里需要注意的是，在我们使用 <code class="language-plaintext highlighter-rouge">divide</code> 方法的时候尽量使用 3 个参数版本，并且<code class="language-plaintext highlighter-rouge">RoundingMode</code> 不要选择 <code class="language-plaintext highlighter-rouge">UNNECESSARY</code>，否则很可能会遇到 <code class="language-plaintext highlighter-rouge">ArithmeticException</code>（无法除尽出现无限循环小数的时候），其中 <code class="language-plaintext highlighter-rouge">scale</code> 表示要保留几位小数，<code class="language-plaintext highlighter-rouge">roundingMode</code> 代表保留规则。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">BigDecimal</span> <span class="nf">divide</span><span class="o">(</span><span class="nc">BigDecimal</span> <span class="n">divisor</span><span class="o">,</span> <span class="kt">int</span> <span class="n">scale</span><span class="o">,</span> <span class="nc">RoundingMode</span> <span class="n">roundingMode</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">divide</span><span class="o">(</span><span class="n">divisor</span><span class="o">,</span> <span class="n">scale</span><span class="o">,</span> <span class="n">roundingMode</span><span class="o">.</span><span class="na">oldMode</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>保留规则非常多，这里列举几种:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">enum</span> <span class="nc">RoundingMode</span> <span class="o">{</span>
   <span class="c1">// 2.5 -&gt; 3 , 1.6 -&gt; 2</span>
   <span class="c1">// -1.6 -&gt; -2 , -2.5 -&gt; -3</span>
   <span class="no">UP</span><span class="o">(</span><span class="nc">BigDecimal</span><span class="o">.</span><span class="na">ROUND_UP</span><span class="o">),</span>
   <span class="c1">// 2.5 -&gt; 2 , 1.6 -&gt; 1</span>
   <span class="c1">// -1.6 -&gt; -1 , -2.5 -&gt; -2</span>
   <span class="no">DOWN</span><span class="o">(</span><span class="nc">BigDecimal</span><span class="o">.</span><span class="na">ROUND_DOWN</span><span class="o">),</span>
   <span class="c1">// 2.5 -&gt; 3 , 1.6 -&gt; 2</span>
   <span class="c1">// -1.6 -&gt; -1 , -2.5 -&gt; -2</span>
   <span class="no">CEILING</span><span class="o">(</span><span class="nc">BigDecimal</span><span class="o">.</span><span class="na">ROUND_CEILING</span><span class="o">),</span>
   <span class="c1">// 2.5 -&gt; 2 , 1.6 -&gt; 1</span>
   <span class="c1">// -1.6 -&gt; -2 , -2.5 -&gt; -3</span>
   <span class="no">FLOOR</span><span class="o">(</span><span class="nc">BigDecimal</span><span class="o">.</span><span class="na">ROUND_FLOOR</span><span class="o">),</span>
   <span class="c1">// 2.5 -&gt; 3 , 1.6 -&gt; 2</span>
   <span class="c1">// -1.6 -&gt; -2 , -2.5 -&gt; -3</span>
   <span class="no">HALF_UP</span><span class="o">(</span><span class="nc">BigDecimal</span><span class="o">.</span><span class="na">ROUND_HALF_UP</span><span class="o">),</span>
   <span class="c1">//......</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="大小比较">大小比较</h3>

<p><code class="language-plaintext highlighter-rouge">a.compareTo(b)</code> : 返回 -1 表示 <code class="language-plaintext highlighter-rouge">a</code> 小于 <code class="language-plaintext highlighter-rouge">b</code>，0 表示 <code class="language-plaintext highlighter-rouge">a</code> 等于 <code class="language-plaintext highlighter-rouge">b</code> ， 1 表示 <code class="language-plaintext highlighter-rouge">a</code> 大于 <code class="language-plaintext highlighter-rouge">b</code>。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BigDecimal</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"1.0"</span><span class="o">);</span>
<span class="nc">BigDecimal</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"0.9"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">b</span><span class="o">));</span><span class="c1">// 1</span>
</code></pre></div></div>

<h3 id="保留几位小数">保留几位小数</h3>

<p>通过 <code class="language-plaintext highlighter-rouge">setScale</code>方法设置保留几位小数以及保留规则。保留规则有挺多种，不需要记，IDEA 会提示。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BigDecimal</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"1.255433"</span><span class="o">);</span>
<span class="nc">BigDecimal</span> <span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">setScale</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="nc">RoundingMode</span><span class="o">.</span><span class="na">HALF_DOWN</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">n</span><span class="o">);</span><span class="c1">// 1.255</span>
</code></pre></div></div>

<h2 id="bigdecimal-等值比较问题">BigDecimal 等值比较问题</h2>

<p>《阿里巴巴 Java 开发手册》中提到：</p>

<p><img src="https://oss.javaguide.cn/github/javaguide/java/basis/image-20220714161315993.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">BigDecimal</code> 使用 <code class="language-plaintext highlighter-rouge">equals()</code> 方法进行等值比较出现问题的代码示例：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BigDecimal</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>
<span class="nc">BigDecimal</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"1.0"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">b</span><span class="o">));</span><span class="c1">//false</span>
</code></pre></div></div>

<p>这是因为 <code class="language-plaintext highlighter-rouge">equals()</code> 方法不仅仅会比较值的大小（value）还会比较精度（scale），而 <code class="language-plaintext highlighter-rouge">compareTo()</code> 方法比较的时候会忽略精度。</p>

<p>1.0 的 scale 是 1，1 的 scale 是 0，因此 <code class="language-plaintext highlighter-rouge">a.equals(b)</code> 的结果是 false。</p>

<p><img src="https://oss.javaguide.cn/github/javaguide/java/basis/image-20220714164706390.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">compareTo()</code> 方法可以比较两个 <code class="language-plaintext highlighter-rouge">BigDecimal</code> 的值，如果相等就返回 0，如果第 1 个数比第 2 个数大则返回 1，反之返回-1。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BigDecimal</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>
<span class="nc">BigDecimal</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"1.0"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">b</span><span class="o">));</span><span class="c1">//0</span>
</code></pre></div></div>

<h2 id="bigdecimal-工具类分享">BigDecimal 工具类分享</h2>

<p>网上有一个使用人数比较多的 <code class="language-plaintext highlighter-rouge">BigDecimal</code> 工具类，提供了多个静态方法来简化 <code class="language-plaintext highlighter-rouge">BigDecimal</code> 的操作。</p>

<p>我对其进行了简单改进，分享一下源码：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.math.BigDecimal</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.math.RoundingMode</span><span class="o">;</span>

<span class="cm">/**
 * 简化BigDecimal计算的小工具类
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BigDecimalUtil</span> <span class="o">{</span>

    <span class="cm">/**
     * 默认除法运算精度
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEF_DIV_SCALE</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">BigDecimalUtil</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 提供精确的加法运算。
     *
     * @param v1 被加数
     * @param v2 加数
     * @return 两个参数的和
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">add</span><span class="o">(</span><span class="kt">double</span> <span class="n">v1</span><span class="o">,</span> <span class="kt">double</span> <span class="n">v2</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BigDecimal</span> <span class="n">b1</span> <span class="o">=</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v1</span><span class="o">);</span>
        <span class="nc">BigDecimal</span> <span class="n">b2</span> <span class="o">=</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v2</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">b1</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">b2</span><span class="o">).</span><span class="na">doubleValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 提供精确的减法运算。
     *
     * @param v1 被减数
     * @param v2 减数
     * @return 两个参数的差
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">subtract</span><span class="o">(</span><span class="kt">double</span> <span class="n">v1</span><span class="o">,</span> <span class="kt">double</span> <span class="n">v2</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BigDecimal</span> <span class="n">b1</span> <span class="o">=</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v1</span><span class="o">);</span>
        <span class="nc">BigDecimal</span> <span class="n">b2</span> <span class="o">=</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v2</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">b1</span><span class="o">.</span><span class="na">subtract</span><span class="o">(</span><span class="n">b2</span><span class="o">).</span><span class="na">doubleValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 提供精确的乘法运算。
     *
     * @param v1 被乘数
     * @param v2 乘数
     * @return 两个参数的积
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">multiply</span><span class="o">(</span><span class="kt">double</span> <span class="n">v1</span><span class="o">,</span> <span class="kt">double</span> <span class="n">v2</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BigDecimal</span> <span class="n">b1</span> <span class="o">=</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v1</span><span class="o">);</span>
        <span class="nc">BigDecimal</span> <span class="n">b2</span> <span class="o">=</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v2</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">b1</span><span class="o">.</span><span class="na">multiply</span><span class="o">(</span><span class="n">b2</span><span class="o">).</span><span class="na">doubleValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 提供（相对）精确的除法运算，当发生除不尽的情况时，精确到
     * 小数点以后10位，以后的数字四舍五入。
     *
     * @param v1 被除数
     * @param v2 除数
     * @return 两个参数的商
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">divide</span><span class="o">(</span><span class="kt">double</span> <span class="n">v1</span><span class="o">,</span> <span class="kt">double</span> <span class="n">v2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">divide</span><span class="o">(</span><span class="n">v1</span><span class="o">,</span> <span class="n">v2</span><span class="o">,</span> <span class="no">DEF_DIV_SCALE</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 提供（相对）精确的除法运算。当发生除不尽的情况时，由scale参数指
     * 定精度，以后的数字四舍五入。
     *
     * @param v1    被除数
     * @param v2    除数
     * @param scale 表示表示需要精确到小数点以后几位。
     * @return 两个参数的商
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">divide</span><span class="o">(</span><span class="kt">double</span> <span class="n">v1</span><span class="o">,</span> <span class="kt">double</span> <span class="n">v2</span><span class="o">,</span> <span class="kt">int</span> <span class="n">scale</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
                    <span class="s">"The scale must be a positive integer or zero"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">BigDecimal</span> <span class="n">b1</span> <span class="o">=</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v1</span><span class="o">);</span>
        <span class="nc">BigDecimal</span> <span class="n">b2</span> <span class="o">=</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v2</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">b1</span><span class="o">.</span><span class="na">divide</span><span class="o">(</span><span class="n">b2</span><span class="o">,</span> <span class="n">scale</span><span class="o">,</span> <span class="nc">RoundingMode</span><span class="o">.</span><span class="na">HALF_EVEN</span><span class="o">).</span><span class="na">doubleValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 提供精确的小数位四舍五入处理。
     *
     * @param v     需要四舍五入的数字
     * @param scale 小数点后保留几位
     * @return 四舍五入后的结果
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">round</span><span class="o">(</span><span class="kt">double</span> <span class="n">v</span><span class="o">,</span> <span class="kt">int</span> <span class="n">scale</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">scale</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span>
                    <span class="s">"The scale must be a positive integer or zero"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">BigDecimal</span> <span class="n">b</span> <span class="o">=</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v</span><span class="o">);</span>
        <span class="nc">BigDecimal</span> <span class="n">one</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="na">divide</span><span class="o">(</span><span class="n">one</span><span class="o">,</span> <span class="n">scale</span><span class="o">,</span> <span class="nc">RoundingMode</span><span class="o">.</span><span class="na">HALF_UP</span><span class="o">).</span><span class="na">doubleValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 提供精确的类型转换(Float)
     *
     * @param v 需要被转换的数字
     * @return 返回转换结果
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">convertToFloat</span><span class="o">(</span><span class="kt">double</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BigDecimal</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="n">v</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="na">floatValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 提供精确的类型转换(Int)不进行四舍五入
     *
     * @param v 需要被转换的数字
     * @return 返回转换结果
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">convertsToInt</span><span class="o">(</span><span class="kt">double</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BigDecimal</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="n">v</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="na">intValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 提供精确的类型转换(Long)
     *
     * @param v 需要被转换的数字
     * @return 返回转换结果
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">convertsToLong</span><span class="o">(</span><span class="kt">double</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BigDecimal</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="n">v</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="na">longValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 返回两个数中大的一个值
     *
     * @param v1 需要被对比的第一个数
     * @param v2 需要被对比的第二个数
     * @return 返回两个数中大的一个值
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">returnMax</span><span class="o">(</span><span class="kt">double</span> <span class="n">v1</span><span class="o">,</span> <span class="kt">double</span> <span class="n">v2</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BigDecimal</span> <span class="n">b1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="n">v1</span><span class="o">);</span>
        <span class="nc">BigDecimal</span> <span class="n">b2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="n">v2</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">b1</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">b2</span><span class="o">).</span><span class="na">doubleValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 返回两个数中小的一个值
     *
     * @param v1 需要被对比的第一个数
     * @param v2 需要被对比的第二个数
     * @return 返回两个数中小的一个值
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">returnMin</span><span class="o">(</span><span class="kt">double</span> <span class="n">v1</span><span class="o">,</span> <span class="kt">double</span> <span class="n">v2</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BigDecimal</span> <span class="n">b1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="n">v1</span><span class="o">);</span>
        <span class="nc">BigDecimal</span> <span class="n">b2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="n">v2</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">b1</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">b2</span><span class="o">).</span><span class="na">doubleValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 精确对比两个数字
     *
     * @param v1 需要被对比的第一个数
     * @param v2 需要被对比的第二个数
     * @return 如果两个数一样则返回0，如果第一个数比第二个数大则返回1，反之返回-1
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="kt">double</span> <span class="n">v1</span><span class="o">,</span> <span class="kt">double</span> <span class="n">v2</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BigDecimal</span> <span class="n">b1</span> <span class="o">=</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v1</span><span class="o">);</span>
        <span class="nc">BigDecimal</span> <span class="n">b2</span> <span class="o">=</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">v2</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">b1</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">b2</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>相关 issue：<a href="https://github.com/Snailclimb/JavaGuide/issues/2129">建议对保留规则设置为 RoundingMode.HALF_EVEN,即四舍六入五成双,#2129</a> 。</p>

<p><img src="https://oss.javaguide.cn/github/javaguide/java/basis/RoundingMode.HALF_EVEN.png" alt="RoundingMode.HALF_EVEN" /></p>

<h2 id="总结">总结</h2>

<p>浮点数没有办法用二进制精确表示，因此存在精度丢失的风险。</p>

<p>不过，Java 提供了<code class="language-plaintext highlighter-rouge">BigDecimal</code> 来操作浮点数。<code class="language-plaintext highlighter-rouge">BigDecimal</code> 的实现利用到了 <code class="language-plaintext highlighter-rouge">BigInteger</code> （用来操作大整数）, 所不同的是 <code class="language-plaintext highlighter-rouge">BigDecimal</code> 加入了小数位的概念。</p>

<!-- @include: @article-footer.snippet.md -->
