<h2 id="何为反射">何为反射？</h2>

<p>如果说大家研究过框架的底层原理或者咱们自己写过框架的话，一定对反射这个概念不陌生。</p>

<p>反射之所以被称为框架的灵魂，主要是因为它赋予了我们在运行时分析类以及执行类中方法的能力。</p>

<p>通过反射你可以获取任意一个类的所有属性和方法，你还可以调用这些方法和属性。</p>

<h2 id="反射的应用场景了解么">反射的应用场景了解么？</h2>

<p>像咱们平时大部分时候都是在写业务代码，很少会接触到直接使用反射机制的场景。</p>

<p>但是，这并不代表反射没有用。相反，正是因为反射，你才能这么轻松地使用各种框架。像 Spring/Spring Boot、MyBatis 等等框架中都大量使用了反射机制。</p>

<p><strong>这些框架中也大量使用了动态代理，而动态代理的实现也依赖反射。</strong></p>

<p>比如下面是通过 JDK 实现动态代理的示例代码，其中就使用了反射类 <code class="language-plaintext highlighter-rouge">Method</code> 来调用指定的方法。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DebugInvocationHandler</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>
    <span class="cm">/**
     * 代理类中的真实对象
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">target</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DebugInvocationHandler</span><span class="o">(</span><span class="nc">Object</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InvocationTargetException</span><span class="o">,</span> <span class="nc">IllegalAccessException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"before method "</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"after method "</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>另外，像 Java 中的一大利器 <strong>注解</strong> 的实现也用到了反射。</p>

<p>为什么你使用 Spring 的时候 ，一个<code class="language-plaintext highlighter-rouge">@Component</code>注解就声明了一个类为 Spring Bean 呢？为什么你通过一个 <code class="language-plaintext highlighter-rouge">@Value</code>注解就读取到配置文件中的值呢？究竟是怎么起作用的呢？</p>

<p>这些都是因为你可以基于反射分析类，然后获取到类/属性/方法/方法的参数上的注解。你获取到注解之后，就可以做进一步的处理。</p>

<h2 id="谈谈反射机制的优缺点">谈谈反射机制的优缺点</h2>

<p><strong>优点</strong>：可以让咱们的代码更加灵活、为各种框架提供开箱即用的功能提供了便利</p>

<p><strong>缺点</strong>：让我们在运行时有了分析操作类的能力，这同样也增加了安全问题。比如可以无视泛型参数的安全检查（泛型参数的安全检查发生在编译时）。另外，反射的性能也要稍差点，不过，对于框架来说实际是影响不大的。相关阅读：<a href="https://stackoverflow.com/questions/1392351/java-reflection-why-is-it-so-slow">Java Reflection: Why is it so slow?</a></p>

<h2 id="反射实战">反射实战</h2>

<h3 id="获取-class-对象的四种方式">获取 Class 对象的四种方式</h3>

<p>如果我们动态获取到这些信息，我们需要依靠 Class 对象。Class 类对象将一个类的方法、变量等信息告诉运行的程序。Java 提供了四种方式获取 Class 对象:</p>

<p><strong>1. 知道具体类的情况下可以使用：</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Class</span> <span class="n">alunbarClass</span> <span class="o">=</span> <span class="nc">TargetObject</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
</code></pre></div></div>

<p>但是我们一般是不知道具体类的，基本都是通过遍历包下面的类来获取 Class 对象，通过此方式获取 Class 对象不会进行初始化</p>

<p><strong>2. 通过 <code class="language-plaintext highlighter-rouge">Class.forName()</code>传入类的全路径获取：</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Class</span> <span class="n">alunbarClass1</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"cn.javaguide.TargetObject"</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>3. 通过对象实例<code class="language-plaintext highlighter-rouge">instance.getClass()</code>获取：</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TargetObject</span> <span class="n">o</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TargetObject</span><span class="o">();</span>
<span class="nc">Class</span> <span class="n">alunbarClass2</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
</code></pre></div></div>

<p><strong>4. 通过类加载器<code class="language-plaintext highlighter-rouge">xxxClassLoader.loadClass()</code>传入类路径获取:</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ClassLoader</span><span class="o">.</span><span class="na">getSystemClassLoader</span><span class="o">().</span><span class="na">loadClass</span><span class="o">(</span><span class="s">"cn.javaguide.TargetObject"</span><span class="o">);</span>
</code></pre></div></div>

<p>通过类加载器获取 Class 对象不会进行初始化，意味着不进行包括初始化等一系列步骤，静态代码块和静态对象不会得到执行</p>

<h3 id="反射的一些基本操作">反射的一些基本操作</h3>

<ol>
  <li>创建一个我们要使用反射操作的类 <code class="language-plaintext highlighter-rouge">TargetObject</code>。</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">cn.javaguide</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TargetObject</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">TargetObject</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">"JavaGuide"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">publicMethod</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"I love "</span> <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">privateMethod</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"value is "</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>使用反射操作这个类的方法以及属性</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">cn.javaguide</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span><span class="o">,</span> <span class="nc">NoSuchMethodException</span><span class="o">,</span> <span class="nc">IllegalAccessException</span><span class="o">,</span> <span class="nc">InstantiationException</span><span class="o">,</span> <span class="nc">InvocationTargetException</span><span class="o">,</span> <span class="nc">NoSuchFieldException</span> <span class="o">{</span>
        <span class="cm">/**
         * 获取 TargetObject 类的 Class 对象并且创建 TargetObject 类实例
         */</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"cn.javaguide.TargetObject"</span><span class="o">);</span>
        <span class="nc">TargetObject</span> <span class="n">targetObject</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TargetObject</span><span class="o">)</span> <span class="n">targetClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="cm">/**
         * 获取 TargetObject 类中定义的所有方法
         */</span>
        <span class="nc">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">targetClass</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="cm">/**
         * 获取指定方法并调用
         */</span>
        <span class="nc">Method</span> <span class="n">publicMethod</span> <span class="o">=</span> <span class="n">targetClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"publicMethod"</span><span class="o">,</span>
                <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">publicMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">targetObject</span><span class="o">,</span> <span class="s">"JavaGuide"</span><span class="o">);</span>

        <span class="cm">/**
         * 获取指定参数并对参数进行修改
         */</span>
        <span class="nc">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">targetClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"value"</span><span class="o">);</span>
        <span class="c1">//为了对类中的参数进行修改我们取消安全检查</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">targetObject</span><span class="o">,</span> <span class="s">"JavaGuide"</span><span class="o">);</span>

        <span class="cm">/**
         * 调用 private 方法
         */</span>
        <span class="nc">Method</span> <span class="n">privateMethod</span> <span class="o">=</span> <span class="n">targetClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"privateMethod"</span><span class="o">);</span>
        <span class="c1">//为了调用private方法我们取消安全检查</span>
        <span class="n">privateMethod</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">privateMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">targetObject</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>输出内容：</p>

<pre><code class="language-plain">publicMethod
privateMethod
I love JavaGuide
value is JavaGuide
</code></pre>

<p><strong>注意</strong> : 有读者提到上面代码运行会抛出 <code class="language-plaintext highlighter-rouge">ClassNotFoundException</code> 异常，具体原因是你没有下面把这段代码的包名替换成自己创建的 <code class="language-plaintext highlighter-rouge">TargetObject</code> 所在的包 。
可以参考：<a href="https://www.cnblogs.com/chanshuyi/p/head_first_of_reflection.html">https://www.cnblogs.com/chanshuyi/p/head_first_of_reflection.html</a> 这篇文章。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"cn.javaguide.TargetObject"</span><span class="o">);</span>
</code></pre></div></div>

<!-- @include: @article-footer.snippet.md -->
