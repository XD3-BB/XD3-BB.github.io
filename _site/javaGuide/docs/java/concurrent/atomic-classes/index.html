<h2 id="atomic-原子类介绍">Atomic 原子类介绍</h2>

<p><code class="language-plaintext highlighter-rouge">Atomic</code> 翻译成中文是“原子”的意思。在化学上，原子是构成物质的最小单位，在化学反应中不可分割。在编程中，<code class="language-plaintext highlighter-rouge">Atomic</code> 指的是一个操作具有原子性，即该操作不可分割、不可中断。即使在多个线程同时执行时，该操作要么全部执行完成，要么不执行，不会被其他线程看到部分完成的状态。</p>

<p>原子类简单来说就是具有原子性操作特征的类。</p>

<p><code class="language-plaintext highlighter-rouge">java.util.concurrent.atomic</code> 包中的 <code class="language-plaintext highlighter-rouge">Atomic</code> 原子类提供了一种线程安全的方式来操作单个变量。</p>

<p><code class="language-plaintext highlighter-rouge">Atomic</code> 类依赖于 CAS（Compare-And-Swap，比较并交换）乐观锁来保证其方法的原子性，而不需要使用传统的锁机制（如 <code class="language-plaintext highlighter-rouge">synchronized</code> 块或 <code class="language-plaintext highlighter-rouge">ReentrantLock</code>）。</p>

<p>这篇文章我们只介绍 Atomic 原子类的概念，具体实现原理可以阅读笔者写的这篇文章：<a href="./cas.md">CAS 详解</a>。</p>

<p><img src="https://oss.javaguide.cn/github/javaguide/java/JUC%E5%8E%9F%E5%AD%90%E7%B1%BB%E6%A6%82%E8%A7%88.png" alt="JUC原子类概览" /></p>

<p>根据操作的数据类型，可以将 JUC 包中的原子类分为 4 类：</p>

<p><strong>1、基本类型</strong></p>

<p>使用原子的方式更新基本类型</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AtomicInteger</code>：整型原子类</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicLong</code>：长整型原子类</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicBoolean</code>：布尔型原子类</li>
</ul>

<p><strong>2、数组类型</strong></p>

<p>使用原子的方式更新数组里的某个元素</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AtomicIntegerArray</code>：整型数组原子类</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicLongArray</code>：长整型数组原子类</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicReferenceArray</code>：引用类型数组原子类</li>
</ul>

<p><strong>3、引用类型</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AtomicReference</code>：引用类型原子类</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicMarkableReference</code>：原子更新带有标记的引用类型。该类将 boolean 标记与引用关联起来，<del>也可以解决使用 CAS 进行原子更新时可能出现的 ABA 问题</del>。</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicStampedReference</code>：原子更新带有版本号的引用类型。该类将整数值与引用关联起来，可用于解决原子的更新数据和数据的版本号，可以解决使用 CAS 进行原子更新时可能出现的 ABA 问题。</li>
</ul>

<p><strong>🐛 修正（参见：<a href="https://github.com/Snailclimb/JavaGuide/issues/626">issue#626</a>）</strong> : <code class="language-plaintext highlighter-rouge">AtomicMarkableReference</code> 不能解决 ABA 问题。</p>

<p><strong>4、对象的属性修改类型</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AtomicIntegerFieldUpdater</code>:原子更新整型字段的更新器</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicLongFieldUpdater</code>：原子更新长整型字段的更新器</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicReferenceFieldUpdater</code>：原子更新引用类型里的字段</li>
</ul>

<h2 id="基本类型原子类">基本类型原子类</h2>

<p>使用原子的方式更新基本类型</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AtomicInteger</code>：整型原子类</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicLong</code>：长整型原子类</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicBoolean</code>：布尔型原子类</li>
</ul>

<p>上面三个类提供的方法几乎相同，所以我们这里以 <code class="language-plaintext highlighter-rouge">AtomicInteger</code> 为例子来介绍。</p>

<p><strong><code class="language-plaintext highlighter-rouge">AtomicInteger</code> 类常用方法</strong> ：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">get</span><span class="o">()</span> <span class="c1">//获取当前的值</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndSet</span><span class="o">(</span><span class="kt">int</span> <span class="n">newValue</span><span class="o">)</span><span class="c1">//获取当前的值，并设置新的值</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndIncrement</span><span class="o">()</span><span class="c1">//获取当前的值，并自增</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndDecrement</span><span class="o">()</span> <span class="c1">//获取当前的值，并自减</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">delta</span><span class="o">)</span> <span class="c1">//获取当前的值，并加上预期的值</span>
<span class="kt">boolean</span> <span class="nf">compareAndSet</span><span class="o">(</span><span class="kt">int</span> <span class="n">expect</span><span class="o">,</span> <span class="kt">int</span> <span class="n">update</span><span class="o">)</span> <span class="c1">//如果输入的数值等于预期值，则以原子方式将该值设置为输入值（update）</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">lazySet</span><span class="o">(</span><span class="kt">int</span> <span class="n">newValue</span><span class="o">)</span><span class="c1">//最终设置为newValue, lazySet 提供了一种比 set 方法更弱的语义，可能导致其他线程在之后的一小段时间内还是可以读到旧的值，但可能更高效。</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">AtomicInteger</code> 类使用示例</strong> :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 初始化 AtomicInteger 对象，初始值为 0</span>
<span class="nc">AtomicInteger</span> <span class="n">atomicInt</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

<span class="c1">// 使用 getAndSet 方法获取当前值，并设置新值为 3</span>
<span class="kt">int</span> <span class="n">tempValue</span> <span class="o">=</span> <span class="n">atomicInt</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"tempValue: "</span> <span class="o">+</span> <span class="n">tempValue</span> <span class="o">+</span> <span class="s">"; atomicInt: "</span> <span class="o">+</span> <span class="n">atomicInt</span><span class="o">);</span>

<span class="c1">// 使用 getAndIncrement 方法获取当前值，并自增 1</span>
<span class="n">tempValue</span> <span class="o">=</span> <span class="n">atomicInt</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"tempValue: "</span> <span class="o">+</span> <span class="n">tempValue</span> <span class="o">+</span> <span class="s">"; atomicInt: "</span> <span class="o">+</span> <span class="n">atomicInt</span><span class="o">);</span>

<span class="c1">// 使用 getAndAdd 方法获取当前值，并增加指定值 5</span>
<span class="n">tempValue</span> <span class="o">=</span> <span class="n">atomicInt</span><span class="o">.</span><span class="na">getAndAdd</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"tempValue: "</span> <span class="o">+</span> <span class="n">tempValue</span> <span class="o">+</span> <span class="s">"; atomicInt: "</span> <span class="o">+</span> <span class="n">atomicInt</span><span class="o">);</span>

<span class="c1">// 使用 compareAndSet 方法进行原子性条件更新，期望值为 9，更新值为 10</span>
<span class="kt">boolean</span> <span class="n">updateSuccess</span> <span class="o">=</span> <span class="n">atomicInt</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">9</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Update Success: "</span> <span class="o">+</span> <span class="n">updateSuccess</span> <span class="o">+</span> <span class="s">"; atomicInt: "</span> <span class="o">+</span> <span class="n">atomicInt</span><span class="o">);</span>

<span class="c1">// 获取当前值</span>
<span class="kt">int</span> <span class="n">currentValue</span> <span class="o">=</span> <span class="n">atomicInt</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Current value: "</span> <span class="o">+</span> <span class="n">currentValue</span><span class="o">);</span>

<span class="c1">// 使用 lazySet 方法设置新值为 15</span>
<span class="n">atomicInt</span><span class="o">.</span><span class="na">lazySet</span><span class="o">(</span><span class="mi">15</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"After lazySet, atomicInt: "</span> <span class="o">+</span> <span class="n">atomicInt</span><span class="o">);</span>
</code></pre></div></div>

<p>输出：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">tempValue:</span> <span class="mi">0</span><span class="o">;</span> <span class="nl">atomicInt:</span> <span class="mi">3</span>
<span class="nl">tempValue:</span> <span class="mi">3</span><span class="o">;</span> <span class="nl">atomicInt:</span> <span class="mi">4</span>
<span class="nl">tempValue:</span> <span class="mi">4</span><span class="o">;</span> <span class="nl">atomicInt:</span> <span class="mi">9</span>
<span class="nc">Update</span> <span class="nl">Success:</span> <span class="kc">true</span><span class="o">;</span> <span class="nl">atomicInt:</span> <span class="mi">10</span>
<span class="nc">Current</span> <span class="nl">value:</span> <span class="mi">10</span>
<span class="nc">After</span> <span class="n">lazySet</span><span class="o">,</span> <span class="nl">atomicInt:</span> <span class="mi">15</span>
</code></pre></div></div>

<h2 id="数组类型原子类">数组类型原子类</h2>

<p>使用原子的方式更新数组里的某个元素</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AtomicIntegerArray</code>：整形数组原子类</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicLongArray</code>：长整形数组原子类</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicReferenceArray</code>：引用类型数组原子类</li>
</ul>

<p>上面三个类提供的方法几乎相同，所以我们这里以 <code class="language-plaintext highlighter-rouge">AtomicIntegerArray</code> 为例子来介绍。</p>

<p><strong><code class="language-plaintext highlighter-rouge">AtomicIntegerArray</code> 类常用方法</strong>：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="c1">//获取 index=i 位置元素的值</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndSet</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">newValue</span><span class="o">)</span><span class="c1">//返回 index=i 位置的当前的值，并将其设置为新值：newValue</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndIncrement</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span><span class="c1">//获取 index=i 位置元素的值，并让该位置的元素自增</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndDecrement</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="c1">//获取 index=i 位置元素的值，并让该位置的元素自减</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">delta</span><span class="o">)</span> <span class="c1">//获取 index=i 位置元素的值，并加上预期的值</span>
<span class="kt">boolean</span> <span class="nf">compareAndSet</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">expect</span><span class="o">,</span> <span class="kt">int</span> <span class="n">update</span><span class="o">)</span> <span class="c1">//如果输入的数值等于预期值，则以原子方式将 index=i 位置的元素值设置为输入值（update）</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">lazySet</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">newValue</span><span class="o">)</span><span class="c1">//最终 将index=i 位置的元素设置为newValue,使用 lazySet 设置之后可能导致其他线程在之后的一小段时间内还是可以读到旧的值。</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">AtomicIntegerArray</code> 类使用示例</strong> :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span> <span class="o">=</span> <span class="o">{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">6</span><span class="o">};</span>
<span class="c1">// 创建 AtomicIntegerArray</span>
<span class="nc">AtomicIntegerArray</span> <span class="n">atomicArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicIntegerArray</span><span class="o">(</span><span class="n">nums</span><span class="o">);</span>

<span class="c1">// 打印 AtomicIntegerArray 中的初始值</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Initial values in AtomicIntegerArray:"</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Index "</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">atomicArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">)</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// 使用 getAndSet 方法将索引 0 处的值设置为 2，并返回旧值</span>
<span class="kt">int</span> <span class="n">tempValue</span> <span class="o">=</span> <span class="n">atomicArray</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\nAfter getAndSet(0, 2):"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Returned value: "</span> <span class="o">+</span> <span class="n">tempValue</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">atomicArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Index "</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">atomicArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">)</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// 使用 getAndIncrement 方法将索引 0 处的值加 1，并返回旧值</span>
<span class="n">tempValue</span> <span class="o">=</span> <span class="n">atomicArray</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\nAfter getAndIncrement(0):"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Returned value: "</span> <span class="o">+</span> <span class="n">tempValue</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">atomicArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Index "</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">atomicArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">)</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// 使用 getAndAdd 方法将索引 0 处的值增加 5，并返回旧值</span>
<span class="n">tempValue</span> <span class="o">=</span> <span class="n">atomicArray</span><span class="o">.</span><span class="na">getAndAdd</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\nAfter getAndAdd(0, 5):"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Returned value: "</span> <span class="o">+</span> <span class="n">tempValue</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">atomicArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Index "</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">atomicArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">)</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>输出：</p>

<pre><code class="language-plain">Initial values in AtomicIntegerArray:
Index 0: 1 Index 1: 2 Index 2: 3 Index 3: 4 Index 4: 5 Index 5: 6
After getAndSet(0, 2):
Returned value: 1
Index 0: 2 Index 1: 2 Index 2: 3 Index 3: 4 Index 4: 5 Index 5: 6
After getAndIncrement(0):
Returned value: 2
Index 0: 3 Index 1: 2 Index 2: 3 Index 3: 4 Index 4: 5 Index 5: 6
After getAndAdd(0, 5):
Returned value: 3
Index 0: 8 Index 1: 2 Index 2: 3 Index 3: 4 Index 4: 5 Index 5: 6
</code></pre>

<h2 id="引用类型原子类">引用类型原子类</h2>

<p>基本类型原子类只能更新一个变量，如果需要原子更新多个变量，需要使用 引用类型原子类。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AtomicReference</code>：引用类型原子类</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicStampedReference</code>：原子更新带有版本号的引用类型。该类将整数值与引用关联起来，可用于解决原子的更新数据和数据的版本号，可以解决使用 CAS 进行原子更新时可能出现的 ABA 问题。</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicMarkableReference</code>：原子更新带有标记的引用类型。该类将 boolean 标记与引用关联起来，<del>也可以解决使用 CAS 进行原子更新时可能出现的 ABA 问题。</del></li>
</ul>

<p>上面三个类提供的方法几乎相同，所以我们这里以 <code class="language-plaintext highlighter-rouge">AtomicReference</code> 为例子来介绍。</p>

<p><strong><code class="language-plaintext highlighter-rouge">AtomicReference</code> 类使用示例</strong> :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Person 类</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
    <span class="c1">//省略getter/setter和toString</span>
<span class="o">}</span>


<span class="c1">// 创建 AtomicReference 对象并设置初始值</span>
<span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">ar</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicReference</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="s">"SnailClimb"</span><span class="o">,</span> <span class="mi">22</span><span class="o">));</span>

<span class="c1">// 打印初始值</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Initial Person: "</span> <span class="o">+</span> <span class="n">ar</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>

<span class="c1">// 更新值</span>
<span class="nc">Person</span> <span class="n">updatePerson</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="s">"Daisy"</span><span class="o">,</span> <span class="mi">20</span><span class="o">);</span>
<span class="n">ar</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">ar</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="n">updatePerson</span><span class="o">);</span>

<span class="c1">// 打印更新后的值</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Updated Person: "</span> <span class="o">+</span> <span class="n">ar</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>

<span class="c1">// 尝试再次更新</span>
<span class="nc">Person</span> <span class="n">anotherUpdatePerson</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="s">"John"</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
<span class="kt">boolean</span> <span class="n">isUpdated</span> <span class="o">=</span> <span class="n">ar</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">updatePerson</span><span class="o">,</span> <span class="n">anotherUpdatePerson</span><span class="o">);</span>

<span class="c1">// 打印是否更新成功及最终值</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Second Update Success: "</span> <span class="o">+</span> <span class="n">isUpdated</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Final Person: "</span> <span class="o">+</span> <span class="n">ar</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
</code></pre></div></div>

<p>输出：</p>

<pre><code class="language-plain">Initial Person: Person{name='SnailClimb', age=22}
Updated Person: Person{name='Daisy', age=20}
Second Update Success: true
Final Person: Person{name='John', age=30}
</code></pre>

<p><strong><code class="language-plaintext highlighter-rouge">AtomicStampedReference</code> 类使用示例</strong> :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建一个 AtomicStampedReference 对象，初始值为 "SnailClimb"，初始版本号为 1</span>
<span class="nc">AtomicStampedReference</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">asr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicStampedReference</span><span class="o">&lt;&gt;(</span><span class="s">"SnailClimb"</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>

<span class="c1">// 打印初始值和版本号</span>
<span class="kt">int</span><span class="o">[]</span> <span class="n">initialStamp</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
<span class="nc">String</span> <span class="n">initialRef</span> <span class="o">=</span> <span class="n">asr</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">initialStamp</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Initial Reference: "</span> <span class="o">+</span> <span class="n">initialRef</span> <span class="o">+</span> <span class="s">", Initial Stamp: "</span> <span class="o">+</span> <span class="n">initialStamp</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>

<span class="c1">// 更新值和版本号</span>
<span class="kt">int</span> <span class="n">oldStamp</span> <span class="o">=</span> <span class="n">initialStamp</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
<span class="nc">String</span> <span class="n">oldRef</span> <span class="o">=</span> <span class="n">initialRef</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">newRef</span> <span class="o">=</span> <span class="s">"Daisy"</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">newStamp</span> <span class="o">=</span> <span class="n">oldStamp</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>

<span class="kt">boolean</span> <span class="n">isUpdated</span> <span class="o">=</span> <span class="n">asr</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldRef</span><span class="o">,</span> <span class="n">newRef</span><span class="o">,</span> <span class="n">oldStamp</span><span class="o">,</span> <span class="n">newStamp</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Update Success: "</span> <span class="o">+</span> <span class="n">isUpdated</span><span class="o">);</span>

<span class="c1">// 打印更新后的值和版本号</span>
<span class="kt">int</span><span class="o">[]</span> <span class="n">updatedStamp</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
<span class="nc">String</span> <span class="n">updatedRef</span> <span class="o">=</span> <span class="n">asr</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">updatedStamp</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Updated Reference: "</span> <span class="o">+</span> <span class="n">updatedRef</span> <span class="o">+</span> <span class="s">", Updated Stamp: "</span> <span class="o">+</span> <span class="n">updatedStamp</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>

<span class="c1">// 尝试用错误的版本号更新</span>
<span class="kt">boolean</span> <span class="n">isUpdatedWithWrongStamp</span> <span class="o">=</span> <span class="n">asr</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">newRef</span><span class="o">,</span> <span class="s">"John"</span><span class="o">,</span> <span class="n">oldStamp</span><span class="o">,</span> <span class="n">newStamp</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Update with Wrong Stamp Success: "</span> <span class="o">+</span> <span class="n">isUpdatedWithWrongStamp</span><span class="o">);</span>

<span class="c1">// 打印最终的值和版本号</span>
<span class="kt">int</span><span class="o">[]</span> <span class="n">finalStamp</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
<span class="nc">String</span> <span class="n">finalRef</span> <span class="o">=</span> <span class="n">asr</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">finalStamp</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Final Reference: "</span> <span class="o">+</span> <span class="n">finalRef</span> <span class="o">+</span> <span class="s">", Final Stamp: "</span> <span class="o">+</span> <span class="n">finalStamp</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</code></pre></div></div>

<p>输出结果如下：</p>

<pre><code class="language-plain">Initial Reference: SnailClimb, Initial Stamp: 1
Update Success: true
Updated Reference: Daisy, Updated Stamp: 2
Update with Wrong Stamp Success: false
Final Reference: Daisy, Final Stamp: 2
</code></pre>

<p><strong><code class="language-plaintext highlighter-rouge">AtomicMarkableReference</code> 类使用示例</strong> :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建一个 AtomicMarkableReference 对象，初始值为 "SnailClimb"，初始标记为 false</span>
<span class="nc">AtomicMarkableReference</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">amr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicMarkableReference</span><span class="o">&lt;&gt;(</span><span class="s">"SnailClimb"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>

<span class="c1">// 打印初始值和标记</span>
<span class="kt">boolean</span><span class="o">[]</span> <span class="n">initialMark</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">boolean</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
<span class="nc">String</span> <span class="n">initialRef</span> <span class="o">=</span> <span class="n">amr</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">initialMark</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Initial Reference: "</span> <span class="o">+</span> <span class="n">initialRef</span> <span class="o">+</span> <span class="s">", Initial Mark: "</span> <span class="o">+</span> <span class="n">initialMark</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>

<span class="c1">// 更新值和标记</span>
<span class="nc">String</span> <span class="n">oldRef</span> <span class="o">=</span> <span class="n">initialRef</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">newRef</span> <span class="o">=</span> <span class="s">"Daisy"</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">oldMark</span> <span class="o">=</span> <span class="n">initialMark</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
<span class="kt">boolean</span> <span class="n">newMark</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

<span class="kt">boolean</span> <span class="n">isUpdated</span> <span class="o">=</span> <span class="n">amr</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldRef</span><span class="o">,</span> <span class="n">newRef</span><span class="o">,</span> <span class="n">oldMark</span><span class="o">,</span> <span class="n">newMark</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Update Success: "</span> <span class="o">+</span> <span class="n">isUpdated</span><span class="o">);</span>

<span class="c1">// 打印更新后的值和标记</span>
<span class="kt">boolean</span><span class="o">[]</span> <span class="n">updatedMark</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">boolean</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
<span class="nc">String</span> <span class="n">updatedRef</span> <span class="o">=</span> <span class="n">amr</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">updatedMark</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Updated Reference: "</span> <span class="o">+</span> <span class="n">updatedRef</span> <span class="o">+</span> <span class="s">", Updated Mark: "</span> <span class="o">+</span> <span class="n">updatedMark</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>

<span class="c1">// 尝试用错误的标记更新</span>
<span class="kt">boolean</span> <span class="n">isUpdatedWithWrongMark</span> <span class="o">=</span> <span class="n">amr</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">newRef</span><span class="o">,</span> <span class="s">"John"</span><span class="o">,</span> <span class="n">oldMark</span><span class="o">,</span> <span class="o">!</span><span class="n">newMark</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Update with Wrong Mark Success: "</span> <span class="o">+</span> <span class="n">isUpdatedWithWrongMark</span><span class="o">);</span>

<span class="c1">// 打印最终的值和标记</span>
<span class="kt">boolean</span><span class="o">[]</span> <span class="n">finalMark</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">boolean</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
<span class="nc">String</span> <span class="n">finalRef</span> <span class="o">=</span> <span class="n">amr</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">finalMark</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Final Reference: "</span> <span class="o">+</span> <span class="n">finalRef</span> <span class="o">+</span> <span class="s">", Final Mark: "</span> <span class="o">+</span> <span class="n">finalMark</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
</code></pre></div></div>

<p>输出结果如下：</p>

<pre><code class="language-plain">Initial Reference: SnailClimb, Initial Mark: false
Update Success: true
Updated Reference: Daisy, Updated Mark: true
Update with Wrong Mark Success: false
Final Reference: Daisy, Final Mark: true
</code></pre>

<h2 id="对象的属性修改类型原子类">对象的属性修改类型原子类</h2>

<p>如果需要原子更新某个类里的某个字段时，需要用到对象的属性修改类型原子类。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AtomicIntegerFieldUpdater</code>:原子更新整形字段的更新器</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicLongFieldUpdater</code>：原子更新长整形字段的更新器</li>
  <li><code class="language-plaintext highlighter-rouge">AtomicReferenceFieldUpdater</code>：原子更新引用类型里的字段的更新器</li>
</ul>

<p>要想原子地更新对象的属性需要两步。第一步，因为对象的属性修改类型原子类都是抽象类，所以每次使用都必须使用静态方法 newUpdater()创建一个更新器，并且需要设置想要更新的类和属性。第二步，更新的对象属性必须使用 public volatile 修饰符。</p>

<p>上面三个类提供的方法几乎相同，所以我们这里以 <code class="language-plaintext highlighter-rouge">AtomicIntegerFieldUpdater</code>为例子来介绍。</p>

<p><strong><code class="language-plaintext highlighter-rouge">AtomicIntegerFieldUpdater</code> 类使用示例</strong> :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Person 类</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="c1">// 要使用 AtomicIntegerFieldUpdater，字段必须是 public volatile</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
    <span class="c1">//省略getter/setter和toString</span>
<span class="o">}</span>

<span class="c1">// 创建 AtomicIntegerFieldUpdater 对象</span>
<span class="nc">AtomicIntegerFieldUpdater</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">ageUpdater</span> <span class="o">=</span> <span class="nc">AtomicIntegerFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">(</span><span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"age"</span><span class="o">);</span>

<span class="c1">// 创建 Person 对象</span>
<span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="s">"SnailClimb"</span><span class="o">,</span> <span class="mi">22</span><span class="o">);</span>

<span class="c1">// 打印初始值</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Initial Person: "</span> <span class="o">+</span> <span class="n">person</span><span class="o">);</span>

<span class="c1">// 更新 age 字段</span>
<span class="n">ageUpdater</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">(</span><span class="n">person</span><span class="o">);</span> <span class="c1">// 自增</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"After Increment: "</span> <span class="o">+</span> <span class="n">person</span><span class="o">);</span>

<span class="n">ageUpdater</span><span class="o">.</span><span class="na">addAndGet</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span> <span class="c1">// 增加 5</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"After Adding 5: "</span> <span class="o">+</span> <span class="n">person</span><span class="o">);</span>

<span class="n">ageUpdater</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="mi">28</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span> <span class="c1">// 如果当前值是 28，则设置为 30</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"After Compare and Set (28 to 30): "</span> <span class="o">+</span> <span class="n">person</span><span class="o">);</span>

<span class="c1">// 尝试使用错误的比较值进行更新</span>
<span class="kt">boolean</span> <span class="n">isUpdated</span> <span class="o">=</span> <span class="n">ageUpdater</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="mi">28</span><span class="o">,</span> <span class="mi">35</span><span class="o">);</span> <span class="c1">// 这次应该失败</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Compare and Set (28 to 35) Success: "</span> <span class="o">+</span> <span class="n">isUpdated</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Final Person: "</span> <span class="o">+</span> <span class="n">person</span><span class="o">);</span>
</code></pre></div></div>

<p>输出结果：</p>

<pre><code class="language-plain">Initial Person: Name: SnailClimb, Age: 22
After Increment: Name: SnailClimb, Age: 23
After Adding 5: Name: SnailClimb, Age: 28
After Compare and Set (28 to 30): Name: SnailClimb, Age: 30
Compare and Set (28 to 35) Success: false
Final Person: Name: SnailClimb, Age: 30
</code></pre>

<h2 id="参考">参考</h2>

<ul>
  <li>《Java 并发编程的艺术》</li>
</ul>

<!-- @include: @article-footer.snippet.md -->
